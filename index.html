<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø¬Ù„Ø³ - Arabian Chat</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&family=Amiri:ital,wght@0,400;0,700;1,400&display=swap');
:root{--gold:#c9a84c;--gold2:#f0d080;--gold3:#8b6914;--dark:#0d0a05;--dark2:#1a1408;--dark3:#241c0c;--dark4:#2e2410;--border:rgba(201,168,76,0.3);--border2:rgba(201,168,76,0.6);--text:#e8d5a3;--text2:#b8a070;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Lora',serif;background:var(--dark);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:radial-gradient(ellipse at 20% 50%,rgba(201,168,76,0.05) 0%,transparent 60%),radial-gradient(ellipse at 80% 50%,rgba(201,168,76,0.05) 0%,transparent 60%),url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='none' stroke='%23c9a84c' stroke-width='0.4' stroke-opacity='0.07'%3E%3Cpolygon points='60,5 72,35 105,35 80,55 90,85 60,67 30,85 40,55 15,35 48,35'/%3E%3Crect x='30' y='30' width='60' height='60' transform='rotate(45 60 60)'/%3E%3Ccircle cx='60' cy='60' r='28'/%3E%3C/g%3E%3C/svg%3E");pointer-events:none;z-index:0;}
.particle{position:fixed;border-radius:50%;background:rgba(201,168,76,0.15);pointer-events:none;z-index:0;animation:drift linear infinite;}
@keyframes drift{0%{transform:translateY(100vh) translateX(0);opacity:0;}10%{opacity:1;}90%{opacity:0.4;}100%{transform:translateY(-10vh) translateX(50px);opacity:0;}}
#app{position:relative;z-index:1;}
header{background:linear-gradient(180deg,rgba(8,5,1,0.99),rgba(15,11,4,0.97));border-bottom:2px solid transparent;border-image:linear-gradient(90deg,transparent,var(--gold),transparent) 1;padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:70px;position:sticky;top:0;z-index:100;box-shadow:0 2px 30px rgba(201,168,76,0.2);}
.logo{font-family:'Amiri',serif;font-size:2rem;font-weight:700;background:linear-gradient(135deg,var(--gold3),var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;cursor:pointer;line-height:1;}
.logo-sub{font-size:0.6rem;letter-spacing:4px;display:block;font-family:'Lora',serif;font-style:italic;-webkit-text-fill-color:var(--text2);margin-top:2px;text-transform:uppercase;}
.header-center{display:flex;flex-direction:column;align-items:center;gap:4px;}
.hijri-date{font-family:'Amiri',serif;font-size:0.82rem;color:var(--gold3);}
.lang-toggle{display:flex;background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:20px;overflow:hidden;}
.lang-toggle button{background:none;border:none;color:var(--text2);padding:4px 12px;font-size:0.75rem;cursor:pointer;font-family:'Lora',serif;transition:all 0.2s;}
.lang-toggle button.active{background:rgba(201,168,76,0.18);color:var(--gold);}
.header-right{display:flex;align-items:center;gap:10px;}
.user-badge{display:flex;align-items:center;gap:8px;background:var(--dark3);border:1px solid var(--border);border-radius:24px;padding:6px 14px 6px 8px;font-size:0.85rem;color:var(--text2);}
.avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--gold3),var(--gold));display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:var(--dark);flex-shrink:0;}
.btn{font-family:'Lora',serif;border:none;cursor:pointer;border-radius:6px;font-size:0.9rem;transition:all 0.2s;}
.btn-gold{background:linear-gradient(135deg,var(--gold3),var(--gold));color:var(--dark);padding:10px 20px;font-weight:600;border:1px solid var(--gold2);}
.btn-gold:hover{background:linear-gradient(135deg,var(--gold),var(--gold2));transform:translateY(-1px);box-shadow:0 4px 15px rgba(201,168,76,0.3);}
.btn-gold:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
.btn-outline{background:transparent;color:var(--gold);padding:9px 18px;border:1px solid var(--border2);}
.btn-outline:hover{background:rgba(201,168,76,0.1);}
.btn-danger{background:rgba(192,57,43,0.15);color:#e74c3c;padding:7px 14px;border:1px solid rgba(192,57,43,0.3);font-size:0.8rem;}
.btn-danger:hover{background:rgba(192,57,43,0.3);}
.btn-sm{padding:6px 14px;font-size:0.82rem;}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px;backdrop-filter:blur(6px);}
.modal-overlay.hidden{display:none;}
.modal{background:linear-gradient(160deg,var(--dark3),var(--dark2));border:1px solid var(--border2);border-radius:12px;padding:32px;width:100%;max-width:440px;box-shadow:0 20px 60px rgba(0,0,0,0.9);position:relative;overflow:hidden;}
.modal::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
.modal-geo{position:absolute;top:8px;right:8px;width:40px;height:40px;opacity:0.15;}
.modal h2{font-family:'Amiri',serif;color:var(--gold);text-align:center;margin-bottom:6px;font-size:1.6rem;letter-spacing:2px;}
.ornament{text-align:center;color:var(--gold3);margin:0 0 20px;font-size:1rem;letter-spacing:8px;}
.form-group{margin-bottom:16px;}
.form-group label{display:block;color:var(--text2);font-size:0.8rem;margin-bottom:6px;letter-spacing:1px;text-transform:uppercase;}
input[type=text],input[type=password],input[type=email],textarea{width:100%;background:rgba(0,0,0,0.5);border:1px solid var(--border);border-radius:6px;padding:10px 14px;color:var(--text);font-family:'Lora',serif;font-size:0.9rem;transition:border-color 0.2s;outline:none;}
input:focus,textarea:focus{border-color:var(--gold);box-shadow:0 0 0 2px rgba(201,168,76,0.1);}
.form-actions{display:flex;gap:10px;margin-top:20px;}
.form-actions .btn{flex:1;}
.error-msg{color:#e74c3c;font-size:0.8rem;margin-top:8px;display:none;}
.error-msg.show{display:block;}
.divider{text-align:center;color:var(--text2);font-size:0.8rem;margin:16px 0;position:relative;}
.divider::before,.divider::after{content:'';position:absolute;top:50%;width:38%;height:1px;background:var(--border);}
.divider::before{left:0;}.divider::after{right:0;}

/* â”€â”€ Pages â”€â”€ */
.page{display:none!important;}
.page.active{display:block!important;}
#page-chat.active{display:flex!important;flex-direction:column;height:calc(100vh - 70px);}

#page-home{padding:32px 24px;max-width:1100px;margin:0 auto;}
.home-hero{text-align:center;padding:40px 0 48px;}
.hero-arch{display:inline-block;padding:32px 48px;position:relative;border:1px solid var(--border);border-radius:60% 60% 0 0/30% 30% 0 0;background:linear-gradient(180deg,rgba(201,168,76,0.04),transparent);margin-bottom:24px;}
.hero-arch::before{content:'';position:absolute;inset:-8px;border:1px solid rgba(201,168,76,0.1);border-radius:60% 60% 0 0/30% 30% 0 0;}
.home-hero h1{font-family:'Amiri',serif;font-size:clamp(2rem,6vw,3.5rem);background:linear-gradient(135deg,var(--gold3),var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1.1;}
.home-hero h1 span{display:block;font-size:0.45em;letter-spacing:6px;font-family:'Lora',serif;font-style:italic;-webkit-text-fill-color:var(--text2);margin-top:4px;}
.hero-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:24px;}
.search-bar{display:flex;gap:10px;margin-bottom:32px;}
.search-bar input{flex:1;background:rgba(0,0,0,0.5);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-family:'Lora',serif;font-size:0.95rem;outline:none;}
.search-bar input:focus{border-color:var(--gold);}
.search-bar input::placeholder{color:var(--text2);}
.section-title{font-family:'Amiri',serif;color:var(--gold);font-size:1.2rem;letter-spacing:3px;margin-bottom:20px;padding-bottom:10px;display:flex;align-items:center;justify-content:space-between;position:relative;}
.section-title::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,var(--gold),transparent);}
.rooms-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;}
.room-card{background:linear-gradient(170deg,var(--dark3),var(--dark2));border:1px solid var(--border);border-radius:50% 50% 8px 8px/20% 20% 8px 8px;padding:28px 20px 20px;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden;}
.room-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);opacity:0;transition:opacity 0.3s;}
.room-card:hover{border-color:var(--border2);transform:translateY(-4px);box-shadow:0 12px 40px rgba(201,168,76,0.18);}
.room-card:hover::before{opacity:1;}
.room-card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
.room-name{font-family:'Amiri',serif;color:var(--gold);font-size:1.1rem;}
.room-desc{color:var(--text2);font-size:0.85rem;font-style:italic;margin-bottom:14px;line-height:1.6;}
.room-meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.room-tag{font-size:0.7rem;letter-spacing:1px;text-transform:uppercase;padding:3px 10px;border-radius:20px;background:rgba(201,168,76,0.07);border:1px solid var(--border);color:var(--text2);}
.empty-state{text-align:center;padding:60px 20px;color:var(--text2);grid-column:1/-1;}
.empty-state .icon{font-size:3rem;margin-bottom:16px;opacity:0.5;}

/* â”€â”€ Hadith card â”€â”€ */
.hadith-card{background:linear-gradient(160deg,var(--dark3),var(--dark2));border:1px solid var(--border);border-radius:12px;padding:24px 28px;margin-bottom:32px;position:relative;overflow:hidden;}
.hadith-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
.hadith-label{font-family:'Amiri',serif;color:var(--gold);font-size:1rem;letter-spacing:3px;text-align:center;margin-bottom:16px;}
.hadith-arabic{font-family:'Amiri',serif;font-size:1.15rem;line-height:2;color:var(--text);text-align:right;direction:rtl;margin-bottom:10px;}
.hadith-english{font-size:0.88rem;line-height:1.8;color:var(--text2);font-style:italic;margin-bottom:10px;}
.hadith-source{font-size:0.75rem;color:var(--gold3);text-align:center;letter-spacing:1px;margin-top:4px;}
.hadith-loading{text-align:center;color:var(--text2);font-style:italic;padding:16px 0;}

/* â”€â”€ Chat â”€â”€ */
.chat-header{background:linear-gradient(180deg,rgba(8,5,1,0.99),rgba(18,13,4,0.97));border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.chat-room-name{font-family:'Amiri',serif;color:var(--gold);font-size:1.2rem;letter-spacing:2px;}
.chat-room-meta{color:var(--text2);font-size:0.78rem;margin-top:2px;}
.chat-header-actions{display:flex;gap:8px;align-items:center;}
.messages-area{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:14px;}
.messages-area::-webkit-scrollbar{width:4px;}
.messages-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.msg{display:flex;gap:10px;align-items:flex-end;max-width:72%;}
.msg.own{align-self:flex-end;flex-direction:row-reverse;}
.msg.system{align-self:center;max-width:100%;}
.msg-avatar .avatar{width:34px;height:34px;font-size:0.75rem;}
.msg-bubble{background:linear-gradient(160deg,var(--dark3),var(--dark4));border:1px solid var(--border);border-radius:48% 48% 8px 8px/18% 18% 8px 8px;padding:16px 14px 10px;max-width:100%;position:relative;cursor:pointer;transition:border-color 0.2s;}
.msg-bubble:hover{border-color:var(--border2);}
.msg.own .msg-bubble{background:linear-gradient(160deg,rgba(139,105,20,0.22),rgba(80,58,8,0.28));border-color:rgba(201,168,76,0.35);}
.msg.system .msg-bubble{background:rgba(201,168,76,0.05);border-color:var(--border);border-radius:20px;padding:6px 20px;text-align:center;cursor:default;}
.msg-bubble::after{content:'âœ¦';position:absolute;top:4px;right:8px;font-size:0.45rem;color:var(--gold3);opacity:0.5;}
.msg.system .msg-bubble::after{display:none;}
.msg-author{font-family:'Amiri',serif;font-size:0.82rem;color:var(--gold);margin-bottom:4px;font-weight:700;}
.msg-text{font-size:0.9rem;line-height:1.6;word-break:break-word;}
.msg.system .msg-text{font-size:0.78rem;color:var(--text2);font-style:italic;font-family:'Amiri',serif;}
.msg-time{font-size:0.65rem;color:var(--text2);margin-top:6px;text-align:right;}
.msg-translation{margin-top:10px;padding-top:8px;border-top:1px solid var(--border);font-size:0.82rem;color:var(--text2);line-height:1.6;font-style:italic;display:none;}
.msg-translation.show{display:block;}
.translate-hint{font-size:0.65rem;color:var(--gold3);margin-top:4px;opacity:0.7;}
.msg-img{max-width:260px;max-height:260px;border-radius:8px 8px 4px 4px;display:block;margin-top:8px;cursor:pointer;border:1px solid var(--border);}
.chat-input-area{background:rgba(8,5,1,0.98);border-top:1px solid var(--border);padding:16px 20px;flex-shrink:0;}
.chat-input-row{display:flex;gap:10px;align-items:flex-end;background:rgba(0,0,0,0.45);border:1px solid var(--border);border-radius:10px;padding:8px 12px;transition:border-color 0.2s;}
.chat-input-row:focus-within{border-color:var(--gold);}
#msg-input{flex:1;background:transparent;border:none;color:var(--text);font-family:'Lora',serif;font-size:0.9rem;resize:none;outline:none;max-height:120px;min-height:36px;line-height:1.5;padding-top:4px;}
#msg-input::placeholder{color:var(--text2);font-style:italic;}
.img-upload-btn{background:none;border:none;cursor:pointer;color:var(--gold3);font-size:1.3rem;padding:4px 6px;transition:color 0.2s;}
.img-upload-btn:hover{color:var(--gold);}
.send-btn{background:linear-gradient(135deg,var(--gold3),var(--gold));border:none;border-radius:50%;cursor:pointer;width:38px;height:38px;display:flex;align-items:center;justify-content:center;color:var(--dark);font-size:1.1rem;transition:all 0.2s;flex-shrink:0;}
.send-btn:hover{transform:scale(1.1);box-shadow:0 0 14px rgba(201,168,76,0.4);}
.image-preview-wrap{display:none;padding:8px 0;position:relative;width:fit-content;}
.image-preview-wrap.show{display:block;}
.image-preview-thumb{width:72px;height:72px;object-fit:cover;border-radius:6px;border:1px solid var(--border2);}
.remove-preview{position:absolute;top:-6px;right:-6px;background:#c0392b;color:#fff;border:none;border-radius:50%;width:18px;height:18px;cursor:pointer;font-size:0.65rem;display:flex;align-items:center;justify-content:center;}
.sound-btn{background:none;border:1px solid var(--border);border-radius:20px;color:var(--text2);padding:4px 10px;font-size:0.75rem;cursor:pointer;transition:all 0.2s;font-family:'Lora',serif;}
.sound-btn:hover{border-color:var(--gold);color:var(--gold);}
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.93);display:flex;align-items:center;justify-content:center;z-index:300;cursor:zoom-out;backdrop-filter:blur(10px);}
.lightbox.hidden{display:none;}
.lightbox img{max-width:90vw;max-height:90vh;border-radius:8px;border:1px solid var(--border2);}
@keyframes spin{to{transform:rotate(360deg);}}
.spin{display:inline-block;width:12px;height:12px;border:2px solid rgba(201,168,76,0.3);border-top-color:var(--gold);border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;margin-right:4px;}
@media(max-width:600px){header{padding:0 10px;}.header-center{display:none;}#page-home{padding:16px 12px;}.msg{max-width:90%;}.messages-area{padding:12px;}.chat-input-area{padding:10px;}.hero-arch{padding:20px 24px;}}
</style>
</head>
<body>
<script>
for(let i=0;i<10;i++){const p=document.createElement('div');p.className='particle';const s=Math.random()*4+2;p.style.cssText=`width:${s}px;height:${s}px;left:${Math.random()*100}%;animation-duration:${Math.random()*20+15}s;animation-delay:${Math.random()*15}s;`;document.body.appendChild(p);}
</script>
<div id="app">
  <header>
    <div class="logo" onclick="navigate('home')">Ù…Ø¬Ù„Ø³<span class="logo-sub">Unmarried Gathering</span></div>
    <div class="header-center">
      <div class="hijri-date" id="hijri-date"></div>
      <div class="lang-toggle">
        <button id="btn-en" onclick="setLang('en')" class="active">EN</button>
        <button id="btn-ar" onclick="setLang('ar')">Ø¹Ø±</button>
      </div>
    </div>
    <div class="header-right" id="header-right"></div>
  </header>

  <!-- HOME -->
  <div id="page-home" class="page active">
    <div class="home-hero">
      <div class="hero-arch"><h1>Ù…Ø¬Ù„Ø³<span id="hero-sub"></span></h1></div>
      <div class="hero-actions" id="hero-actions"></div>
    </div>
    <!-- Hadith Card -->
    <div class="hadith-card">
      <div class="hadith-label" id="hadith-label">âœ¦ Hadith of the Day âœ¦</div>
      <div id="hadith-body"><div class="hadith-loading"><span class="spin"></span></div></div>
      <div class="hadith-source" id="hadith-source"></div>
    </div>
    <div class="search-bar"><input type="text" id="search-input" oninput="filterRooms()"></div>
    <div class="section-title"><span id="rooms-label"></span></div>
    <div class="rooms-grid" id="rooms-grid"><div class="empty-state"><div class="icon">ğŸ•Œ</div><p>Loading...</p></div></div>
  </div>

  <!-- CHAT -->
  <div id="page-chat" class="page">
    <div class="chat-header">
      <div>
        <div class="chat-room-name" id="chat-room-name"></div>
        <div class="chat-room-meta" id="chat-room-meta"></div>
      </div>
      <div class="chat-header-actions">
        <button class="sound-btn" id="sound-btn" onclick="toggleSound()">ğŸ”” ON</button>
        <button class="btn btn-outline btn-sm" id="leave-btn" onclick="leaveRoom()"></button>
        <button class="btn btn-danger btn-sm" id="delete-room-btn" style="display:none" onclick="deleteRoom()"></button>
      </div>
    </div>
    <div class="messages-area" id="messages-area"></div>
    <div class="chat-input-area">
      <div class="image-preview-wrap" id="img-preview-wrap">
        <img id="img-preview-thumb" class="image-preview-thumb" src="" alt="">
        <button class="remove-preview" onclick="clearImagePreview()">âœ•</button>
      </div>
      <div class="chat-input-row">
        <button class="img-upload-btn" onclick="document.getElementById('img-file-input').click()">ğŸ–¼</button>
        <input type="file" id="img-file-input" accept="image/*" style="display:none" onchange="handleImageSelect(event)">
        <textarea id="msg-input" rows="1" onkeydown="handleMsgKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" onclick="sendMessage()">â¤</button>
      </div>
    </div>
  </div>

  <div class="lightbox hidden" id="lightbox" onclick="closeLightbox()">
    <img id="lightbox-img" src="" alt="">
  </div>

  <!-- REGISTER MODAL -->
  <div class="modal-overlay hidden" id="modal-register">
    <div class="modal">
      <svg class="modal-geo" viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,13 36,13 27,20 30,32 20,25 10,32 13,20 4,13 16,13" stroke="#c9a84c" stroke-width="1" fill="none"/></svg>
      <h2 id="reg-title"></h2><div class="ornament">âœ¦ â—† âœ¦</div>
      <div class="form-group"><label id="lbl-reg-name"></label><input type="text" id="reg-username"></div>
      <div class="form-group"><label id="lbl-reg-email"></label><input type="email" id="reg-email"></div>
      <div class="form-group"><label id="lbl-reg-pass"></label><input type="password" id="reg-password"></div>
      <div class="error-msg" id="reg-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" id="reg-cancel" onclick="hideModal('register')"></button>
        <button class="btn btn-gold" id="reg-btn" onclick="register()"></button>
      </div>
      <div class="divider" id="reg-divider"></div>
      <button class="btn btn-outline" style="width:100%" id="reg-switch" onclick="hideModal('register');showModal('login')"></button>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modal-overlay hidden" id="modal-login">
    <div class="modal">
      <svg class="modal-geo" viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,13 36,13 27,20 30,32 20,25 10,32 13,20 4,13 16,13" stroke="#c9a84c" stroke-width="1" fill="none"/></svg>
      <h2 id="login-title"></h2><div class="ornament">âœ¦ â—† âœ¦</div>
      <div class="form-group"><label id="lbl-login-email"></label><input type="email" id="login-email"></div>
      <div class="form-group"><label id="lbl-login-pass"></label><input type="password" id="login-password"></div>
      <div class="error-msg" id="login-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" id="login-cancel" onclick="hideModal('login')"></button>
        <button class="btn btn-gold" id="login-btn" onclick="login()"></button>
      </div>
      <div class="divider" id="login-divider"></div>
      <button class="btn btn-outline" style="width:100%" id="login-switch" onclick="hideModal('login');showModal('register')"></button>
    </div>
  </div>

  <!-- CREATE ROOM MODAL -->
  <div class="modal-overlay hidden" id="modal-create-room">
    <div class="modal">
      <svg class="modal-geo" viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,13 36,13 27,20 30,32 20,25 10,32 13,20 4,13 16,13" stroke="#c9a84c" stroke-width="1" fill="none"/></svg>
      <h2 id="cr-title"></h2><div class="ornament">âœ¦ â—† âœ¦</div>
      <div class="form-group"><label id="lbl-cr-name"></label><input type="text" id="room-name-input"></div>
      <div class="form-group"><label id="lbl-cr-desc"></label><input type="text" id="room-desc-input"></div>
      <div class="form-group"><label id="lbl-cr-pass"></label><input type="password" id="room-pass-input"></div>
      <div class="error-msg" id="room-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" id="cr-cancel" onclick="hideModal('create-room')"></button>
        <button class="btn btn-gold" id="cr-btn" onclick="createRoom()"></button>
      </div>
    </div>
  </div>

  <!-- JOIN ROOM MODAL -->
  <div class="modal-overlay hidden" id="modal-join-room">
    <div class="modal">
      <svg class="modal-geo" viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,13 36,13 27,20 30,32 20,25 10,32 13,20 4,13 16,13" stroke="#c9a84c" stroke-width="1" fill="none"/></svg>
      <h2 id="join-title"></h2><div class="ornament">âœ¦ â—† âœ¦</div>
      <p id="join-desc" style="color:var(--text2);text-align:center;margin-bottom:20px;font-family:'Amiri',serif;font-size:1rem;"></p>
      <div class="form-group"><label id="lbl-join-pass"></label><input type="password" id="join-pass-input"></div>
      <div class="error-msg" id="join-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" id="join-cancel" onclick="hideModal('join-room')"></button>
        <button class="btn btn-gold" id="join-enter" onclick="joinRoomWithPassword()"></button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,onAuthStateChanged,updateProfile}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import{getFirestore,collection,doc,addDoc,setDoc,getDocs,deleteDoc,onSnapshot,query,orderBy,serverTimestamp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyBEyS6QjmOpS-DOKDdO1h-3qEKca79_HoA",authDomain:"majlis-61b79.firebaseapp.com",projectId:"majlis-61b79",storageBucket:"majlis-61b79.firebasestorage.app",messagingSenderId:"633132324226",appId:"1:633132324226:web:160eb3dfe90e03d052eb9b"};
const fbApp=initializeApp(firebaseConfig);
const auth=getAuth(fbApp);
const db=getFirestore(fbApp);

let currentUser=null,allRooms=[],currentRoomId=null,pendingRoomId=null,imageData=null,msgUnsub=null,roomsUnsub=null,uiLang='en',soundEnabled=true,lastMsgCount=0;
const transCache={};

// â”€â”€ Expose globals so HTML onclick can reach them â”€â”€
window.toggleSound=function(){
  soundEnabled=!soundEnabled;
  const b=document.getElementById('sound-btn');
  if(b)b.textContent=`ğŸ”” ${soundEnabled?'ON':'OFF'}`;
};
window.navigate=navigate;
window.setLang=setLang;
window.showModal=id=>document.getElementById('modal-'+id).classList.remove('hidden');
window.hideModal=id=>{document.getElementById('modal-'+id).classList.add('hidden');clearErrors();};
window.filterRooms=renderRooms;
window.leaveRoom=leaveRoom;
window.deleteRoom=deleteRoom;
window.sendMessage=sendMessage;
window.handleMsgKey=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}};
window.autoResize=el=>{el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';};
window.handleImageSelect=handleImageSelect;
window.clearImagePreview=clearImagePreview;
window.openLightbox=src=>{document.getElementById('lightbox-img').src=src;document.getElementById('lightbox').classList.remove('hidden');};
window.closeLightbox=()=>document.getElementById('lightbox').classList.add('hidden');
window.translateMsg=translateMsg;
window.tryEnterRoom=tryEnterRoom;
window.joinRoomWithPassword=joinRoomWithPassword;
window.createRoom=createRoom;
window.register=register;
window.login=login;
window.logout=async()=>{leaveRoom();await signOut(auth);};

// â”€â”€ Sound â”€â”€
let audioCtx=null;
function getAudioCtx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
function playNotification(){
  if(!soundEnabled)return;
  try{
    const ctx=getAudioCtx();
    [220,440,660].forEach((freq,i)=>{
      const osc=ctx.createOscillator(),g=ctx.createGain();
      osc.type='sine';osc.frequency.setValueAtTime(freq,ctx.currentTime);
      g.gain.setValueAtTime(i===0?0.18:0.08,ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+1.2);
      osc.connect(g);g.connect(ctx.destination);
      osc.start(ctx.currentTime);osc.stop(ctx.currentTime+1.2);
    });
  }catch(e){}
}

// â”€â”€ Hadith (api.hadith.gading.dev) â”€â”€
const COLLECTIONS=['bukhari','muslim','abu-dawud','ibn-majah','tirmidzi'];
const COLLECTION_SIZES={bukhari:7563,muslim:3032,'abu-dawud':5274,'ibn-majah':4341,tirmidzi:3956};
const COLLECTION_LABELS={bukhari:'Sahih Bukhari',muslim:'Sahih Muslim','abu-dawud':'Sunan Abu Dawud','ibn-majah':'Sunan Ibn Majah',tirmidzi:"Jami' at-Tirmidhi"};

async function loadHadith(){
  const col=COLLECTIONS[Math.floor(Math.random()*COLLECTIONS.length)];
  const num=Math.floor(Math.random()*COLLECTION_SIZES[col])+1;
  const isAr=uiLang==='ar';
  document.getElementById('hadith-label').textContent=isAr?'âœ¦ Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ… âœ¦':'âœ¦ Hadith of the Day âœ¦';
  document.getElementById('hadith-body').innerHTML=`<div class="hadith-loading"><span class="spin"></span></div>`;
  document.getElementById('hadith-source').textContent='';
  try{
    const res=await fetch(`https://api.hadith.gading.dev/books/${col}/${num}`);
    const data=await res.json();
    const h=data?.data?.contents;
    if(!h)throw new Error('no data');
    const arabic=h.arab||'';
    const english=h.id||''; // this API returns Indonesian; fall back gracefully
    // fetch English from another endpoint if needed â€” for now show Arabic + available text
    let bodyHtml='';
    if(isAr){
      bodyHtml=`${arabic?`<div class="hadith-arabic">${arabic}</div>`:''}${english?`<div class="hadith-english">${english}</div>`:''}`;
    }else{
      bodyHtml=`${english?`<div class="hadith-english">${english}</div>`:''}${arabic?`<div class="hadith-arabic">${arabic}</div>`:''}`;
    }
    document.getElementById('hadith-body').innerHTML=bodyHtml||`<div class="hadith-english">Hadith not available.</div>`;
    document.getElementById('hadith-source').textContent=`â€” ${COLLECTION_LABELS[col]}, No. ${num}`;
  }catch(e){
    // API failed â€” show a reliable fallback hadith
    const fallbacks=[
      {ar:'Ø®ÙÙŠÙ’Ø±ÙÙƒÙÙ…Ù’ Ø®ÙÙŠÙ’Ø±ÙÙƒÙÙ…Ù’ Ù„ÙØ£ÙÙ‡Ù’Ù„ÙÙ‡Ù ÙˆÙØ£ÙÙ†ÙØ§ Ø®ÙÙŠÙ’Ø±ÙÙƒÙÙ…Ù’ Ù„ÙØ£ÙÙ‡Ù’Ù„ÙÙŠ',en:'The best of you are those who are best to their families, and I am the best of you to my family.',src:'Sahih Bukhari, No. 5090'},
      {ar:'Ø¥ÙÙ†ÙÙ‘Ù…ÙØ§ Ø§Ù„Ø£ÙØ¹Ù’Ù…ÙØ§Ù„Ù Ø¨ÙØ§Ù„Ù†ÙÙ‘ÙŠÙÙ‘Ø§ØªÙ',en:'Actions are judged by their intentions.',src:'Sahih Bukhari, No. 1'},
      {ar:'Ø§Ù„Ù’Ù…ÙØ³Ù’Ù„ÙÙ…Ù Ù…ÙÙ†Ù’ Ø³ÙÙ„ÙÙ…Ù Ø§Ù„Ù’Ù…ÙØ³Ù’Ù„ÙÙ…ÙÙˆÙ†Ù Ù…ÙÙ†Ù’ Ù„ÙØ³ÙØ§Ù†ÙÙ‡Ù ÙˆÙÙŠÙØ¯ÙÙ‡Ù',en:'A Muslim is one from whose tongue and hand other Muslims are safe.',src:'Sahih Bukhari, No. 10'},
    ];
    const f=fallbacks[Math.floor(Math.random()*fallbacks.length)];
    document.getElementById('hadith-body').innerHTML=isAr
      ?`<div class="hadith-arabic">${f.ar}</div><div class="hadith-english">${f.en}</div>`
      :`<div class="hadith-english">${f.en}</div><div class="hadith-arabic">${f.ar}</div>`;
    document.getElementById('hadith-source').textContent=`â€” ${f.src}`;
  }
}

// â”€â”€ Language detection â”€â”€
function detectLang(text){
  if(/[\u0980-\u09FF]/.test(text))return'bn';
  if(/[\u0600-\u06FF]/.test(text))return'ar';
  return'en';
}

// â”€â”€ UI Strings â”€â”€
const S={
  en:{heroSub:'Enter the Gathering',searchPh:'ğŸ”  Search rooms...',roomsLabel:'âœ¦ Open Gatherings',newRoom:'+ New Room',signin:'Sign In',join:'Join',logout:'Leave',regTitle:'Join the Majlis',regName:'Username',regEmail:'Email',regPass:'Password',regCancel:'Cancel',regBtn:'Join',regDivider:'Already a member?',regSwitch:'Sign In Instead',loginTitle:'Welcome Back',loginEmail:'Email',loginPass:'Password',loginCancel:'Cancel',loginBtn:'Enter',loginDivider:'New here?',loginSwitch:'Create Account',crTitle:'Open a Gathering',crName:'Room Name',crDesc:'Description',crPass:'Password (optional)',crCancel:'Cancel',crBtn:'Open',joinTitle:'Protected Room',joinDesc:'This gathering is password protected.',joinPass:'Password',joinCancel:'Cancel',joinEnter:'Enter',leaveBtn:'â† Leave',deleteBtn:'Delete Room',msgPh:'Write your message...',tapTranslate:'Tap to translate',translating:'Translating...',byLabel:'by',msgCount:'messages',yourRoom:'Your Room',emptyRooms:'No gatherings yet. Be the first!',noResults:'No rooms found.',openRoom:'ğŸ”“ Open',protectedRoom:'ğŸ”’ Protected',errFill:'Please fill all fields.',errPass6:'Password must be at least 6 characters.',errWrongPass:'Incorrect password.',errDel:'Delete this room? Cannot be undone.',errImg:'Image must be under 3MB.',sysEntered:'has entered the gathering',noAccount:'No account found.',wrongPass:'Incorrect email or password.',emailUsed:'Email already registered.',weakPass:'Password is too weak.'},
  ar:{heroSub:'Ø§Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¬Ù„Ø³',searchPh:'ğŸ”  Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¬Ù„Ø³...',roomsLabel:'âœ¦ Ø§Ù„Ù…Ø¬Ø§Ù„Ø³ Ø§Ù„Ù…ÙØªÙˆØ­Ø©',newRoom:'+ Ø§ÙØªØ­ Ù…Ø¬Ù„Ø³Ø§Ù‹',signin:'Ø¯Ø®ÙˆÙ„',join:'ØªÙØ¶Ù„',logout:'Ø®Ø±ÙˆØ¬',regTitle:'Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹',regName:'Ø§Ù„Ø§Ø³Ù…',regEmail:'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',regPass:'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',regCancel:'Ø¥Ù„ØºØ§Ø¡',regBtn:'Ø§Ù†Ø¶Ù…',regDivider:'Ø¹Ø¶Ùˆ Ù…Ø³Ø¬Ù„ØŸ',regSwitch:'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',loginTitle:'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ',loginEmail:'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',loginPass:'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',loginCancel:'Ø¥Ù„ØºØ§Ø¡',loginBtn:'Ø¯Ø®ÙˆÙ„',loginDivider:'Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ØŸ',loginSwitch:'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨',crTitle:'Ø§ÙØªØ­ Ù…Ø¬Ù„Ø³Ø§Ù‹',crName:'Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø³',crDesc:'Ø§Ù„ÙˆØµÙ',crPass:'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',crCancel:'Ø¥Ù„ØºØ§Ø¡',crBtn:'Ø§ÙØªØ­',joinTitle:'Ù…Ø¬Ù„Ø³ Ù…Ø­Ù…ÙŠ',joinDesc:'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø³ Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±.',joinPass:'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',joinCancel:'Ø¥Ù„ØºØ§Ø¡',joinEnter:'ØªÙØ¶Ù„',leaveBtn:'â† Ù…ØºØ§Ø¯Ø±Ø©',deleteBtn:'Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù„Ø³',msgPh:'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...',tapTranslate:'Ø§Ø¶ØºØ· Ù„Ù„ØªØ±Ø¬Ù…Ø©',translating:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©...',byLabel:'Ø¨Ù‚Ù„Ù…',msgCount:'Ø£Ø­Ø§Ø¯ÙŠØ«',yourRoom:'Ù…Ø¬Ù„Ø³Ùƒ',emptyRooms:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ø§Ù„Ø³ Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙØªØ­ Ù…Ø¬Ù„Ø³Ø§Ù‹!',noResults:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ø§Ù„Ø³ Ù…Ø·Ø§Ø¨Ù‚Ø©.',openRoom:'ğŸ”“ Ù…ÙØªÙˆØ­',protectedRoom:'ğŸ”’ Ù…Ø­Ù…ÙŠ',errFill:'ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.',errPass6:'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.',errWrongPass:'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.',errDel:'Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø³ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.',errImg:'Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 3 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª.',sysEntered:'Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¬Ù„Ø³',noAccount:'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.',wrongPass:'Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©.',emailUsed:'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹.',weakPass:'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹.'}
};
const t=k=>S[uiLang][k]||S.en[k]||k;

function applyLang(){
  document.getElementById('btn-en').classList.toggle('active',uiLang==='en');
  document.getElementById('btn-ar').classList.toggle('active',uiLang==='ar');
  set('hero-sub',t('heroSub'));
  document.getElementById('search-input').placeholder=t('searchPh');
  set('rooms-label',t('roomsLabel'));
  document.getElementById('msg-input').placeholder=t('msgPh');
  set('reg-title',t('regTitle'));set('lbl-reg-name',t('regName'));set('lbl-reg-email',t('regEmail'));set('lbl-reg-pass',t('regPass'));set('reg-cancel',t('regCancel'));set('reg-btn',t('regBtn'));set('reg-divider',t('regDivider'));set('reg-switch',t('regSwitch'));
  set('login-title',t('loginTitle'));set('lbl-login-email',t('loginEmail'));set('lbl-login-pass',t('loginPass'));set('login-cancel',t('loginCancel'));set('login-btn',t('loginBtn'));set('login-divider',t('loginDivider'));set('login-switch',t('loginSwitch'));
  set('cr-title',t('crTitle'));set('lbl-cr-name',t('crName'));set('lbl-cr-desc',t('crDesc'));set('lbl-cr-pass',t('crPass'));set('cr-cancel',t('crCancel'));set('cr-btn',t('crBtn'));
  set('join-title',t('joinTitle'));set('join-desc',t('joinDesc'));set('lbl-join-pass',t('joinPass'));set('join-cancel',t('joinCancel'));set('join-enter',t('joinEnter'));
  set('leave-btn',t('leaveBtn'));set('delete-room-btn',t('deleteBtn'));
  updateHeaderUI();renderRooms();
  document.querySelectorAll('.translate-hint').forEach(el=>el.textContent=t('tapTranslate'));
  loadHadith();
}

function setLang(lang){uiLang=lang;applyLang();}

// â”€â”€ Helpers â”€â”€
function set(id,val){const el=document.getElementById(id);if(el)el.textContent=val;}
function v(id){const el=document.getElementById(id);return el?el.value:'';}
function clearFields(ids){ids.forEach(id=>{const el=document.getElementById(id);if(el)el.value='';})}
function showError(id,msg){const el=document.getElementById(id);if(el){el.textContent=msg;el.classList.add('show');}}
function clearErrors(){document.querySelectorAll('.error-msg').forEach(e=>e.classList.remove('show'));}
function escHtml(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escAttr(s){if(!s)return'';return String(s).replace(/'/g,"\\'").replace(/\n/g,' ');}
function setLoading(id,on){const el=document.getElementById(id);if(!el)return;el.disabled=on;if(on){el.dataset.orig=el.textContent;el.innerHTML=`<span class="spin"></span>`;}else el.textContent=el.dataset.orig||'';}
function friendlyError(code){const m={'auth/email-already-in-use':t('emailUsed'),'auth/invalid-email':t('errFill'),'auth/weak-password':t('weakPass'),'auth/user-not-found':t('noAccount'),'auth/wrong-password':t('wrongPass'),'auth/invalid-credential':t('wrongPass')};return m[code]||t('wrongPass');}

try{document.getElementById('hijri-date').textContent=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'numeric',month:'long',year:'numeric'}).format(new Date());}catch(e){}

// â”€â”€ Navigation â”€â”€
function navigate(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
}

// â”€â”€ Auth â”€â”€
onAuthStateChanged(auth,user=>{currentUser=user||null;updateHeaderUI();listenRooms();});

async function register(){
  const name=v('reg-username').trim(),email=v('reg-email').trim(),pass=v('reg-password');
  if(!name||!email||!pass)return showError('reg-error',t('errFill'));
  if(pass.length<6)return showError('reg-error',t('errPass6'));
  setLoading('reg-btn',true);
  try{const cred=await createUserWithEmailAndPassword(auth,email,pass);await updateProfile(cred.user,{displayName:name});currentUser=cred.user;window.hideModal('register');clearFields(['reg-username','reg-email','reg-password']);}
  catch(e){showError('reg-error',friendlyError(e.code));}
  setLoading('reg-btn',false);
}

async function login(){
  const email=v('login-email').trim(),pass=v('login-password');
  if(!email||!pass)return showError('login-error',t('errFill'));
  setLoading('login-btn',true);
  try{await signInWithEmailAndPassword(auth,email,pass);window.hideModal('login');clearFields(['login-email','login-password']);}
  catch(e){showError('login-error',friendlyError(e.code));}
  setLoading('login-btn',false);
}

function updateHeaderUI(){
  const el=document.getElementById('header-right'),ha=document.getElementById('hero-actions');
  if(currentUser){
    const ini=(currentUser.displayName||currentUser.email).substring(0,2).toUpperCase();
    el.innerHTML=`<div class="user-badge"><div class="avatar">${ini}</div><span>${escHtml(currentUser.displayName||currentUser.email)}</span></div><button class="btn btn-outline btn-sm" onclick="logout()">${t('logout')}</button>`;
    ha.innerHTML=`<button class="btn btn-gold" onclick="showModal('create-room')">âœ¦ ${t('newRoom')}</button>`;
  }else{
    el.innerHTML=`<button class="btn btn-outline btn-sm" onclick="showModal('login')">${t('signin')}</button><button class="btn btn-gold btn-sm" onclick="showModal('register')">${t('join')}</button>`;
    ha.innerHTML=`<button class="btn btn-gold" onclick="showModal('register')">âœ¦ ${t('join')}</button><button class="btn btn-outline" onclick="showModal('login')">${t('signin')}</button>`;
  }
}

// â”€â”€ Rooms â”€â”€
function listenRooms(){
  if(roomsUnsub)roomsUnsub();
  roomsUnsub=onSnapshot(query(collection(db,'rooms'),orderBy('createdAt','desc')),snap=>{allRooms=snap.docs.map(d=>({id:d.id,...d.data()}));renderRooms();});
}

function renderRooms(){
  const grid=document.getElementById('rooms-grid');
  const q=(v('search-input')||'').toLowerCase();
  let arr=q?allRooms.filter(r=>r.name.toLowerCase().includes(q)||(r.desc||'').toLowerCase().includes(q)):allRooms;
  if(!arr.length){grid.innerHTML=`<div class="empty-state"><div class="icon">ğŸ•Œ</div><p>${q?t('noResults'):t('emptyRooms')}</p></div>`;return;}
  grid.innerHTML=arr.map(r=>{
    const isOwner=currentUser&&currentUser.uid===r.ownerId;
    return`<div class="room-card" onclick="tryEnterRoom('${r.id}')"><div class="room-card-header"><div class="room-name">${escHtml(r.name)}</div><span>${r.password?'ğŸ”’':'ğŸ”“'}</span></div><div class="room-desc">${escHtml(r.desc||'...')}</div><div class="room-meta"><span class="room-tag">${t('byLabel')} ${escHtml(r.ownerName)}</span><span class="room-tag">${r.msgCount||0} ${t('msgCount')}</span>${isOwner?`<span class="room-tag" style="border-color:rgba(201,168,76,0.5);color:var(--gold)">${t('yourRoom')}</span>`:''}</div></div>`;
  }).join('');
}

async function createRoom(){
  if(!currentUser)return;
  const name=v('room-name-input').trim(),desc=v('room-desc-input').trim(),pass=v('room-pass-input');
  if(!name)return showError('room-error',t('errFill'));
  setLoading('cr-btn',true);
  try{await addDoc(collection(db,'rooms'),{name,desc,password:pass,ownerId:currentUser.uid,ownerName:currentUser.displayName||currentUser.email,createdAt:serverTimestamp(),msgCount:0});window.hideModal('create-room');clearFields(['room-name-input','room-desc-input','room-pass-input']);}
  catch(e){showError('room-error',e.message);}
  setLoading('cr-btn',false);
}

function tryEnterRoom(id){
  if(!currentUser){window.showModal('login');return;}
  const room=allRooms.find(r=>r.id===id);if(!room)return;
  if(room.password){pendingRoomId=id;window.showModal('join-room');}else enterRoom(id);
}

function joinRoomWithPassword(){
  const room=allRooms.find(r=>r.id===pendingRoomId);if(!room)return;
  if(v('join-pass-input')!==room.password)return showError('join-error',t('errWrongPass'));
  window.hideModal('join-room');clearFields(['join-pass-input']);enterRoom(pendingRoomId);
}

function enterRoom(id){
  currentRoomId=id;lastMsgCount=0;
  const room=allRooms.find(r=>r.id===id);
  document.getElementById('chat-room-name').textContent=room.name;
  document.getElementById('chat-room-meta').textContent=(room.desc||'')+(room.password?'  '+t('protectedRoom'):'  '+t('openRoom'));
  document.getElementById('delete-room-btn').style.display=currentUser.uid===room.ownerId?'inline-flex':'none';
  set('delete-room-btn',t('deleteBtn'));set('leave-btn',t('leaveBtn'));
  navigate('chat');
  listenMessages(id);
  addDoc(collection(db,'rooms',id,'messages'),{type:'system',text:uiLang==='ar'?`Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ù€ ${currentUser.displayName||currentUser.email} ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø³`:`${currentUser.displayName||currentUser.email} ${t('sysEntered')}`,ts:serverTimestamp()});
}

function leaveRoom(){
  if(msgUnsub){msgUnsub();msgUnsub=null;}
  currentRoomId=null;lastMsgCount=0;
  document.getElementById('messages-area').innerHTML='';
  navigate('home');
}

async function deleteRoom(){
  const room=allRooms.find(r=>r.id===currentRoomId);
  if(!room||room.ownerId!==currentUser.uid)return;
  if(!confirm(t('errDel')))return;
  const msgs=await getDocs(collection(db,'rooms',currentRoomId,'messages'));
  for(const m of msgs.docs)await deleteDoc(m.ref);
  await deleteDoc(doc(db,'rooms',currentRoomId));
  leaveRoom();
}

// â”€â”€ Messages â”€â”€
function listenMessages(roomId){
  if(msgUnsub)msgUnsub();
  let isFirst=true;
  msgUnsub=onSnapshot(query(collection(db,'rooms',roomId,'messages'),orderBy('ts','asc')),snap=>{
    const area=document.getElementById('messages-area');
    const atBottom=area.scrollHeight-area.clientHeight<=area.scrollTop+60;
    if(!isFirst&&snap.docs.length>lastMsgCount){
      const newest=snap.docs[snap.docs.length-1].data();
      if(newest.authorId!==currentUser?.uid)playNotification();
    }
    lastMsgCount=snap.docs.length;isFirst=false;
    area.innerHTML=snap.docs.map(d=>{
      const m=d.data();
      if(m.type==='system')return`<div class="msg system"><div class="msg-bubble"><div class="msg-text">${escHtml(m.text)}</div></div></div>`;
      const isOwn=m.authorId===currentUser?.uid;
      const ini=(m.author||'?').substring(0,2).toUpperCase();
      const time=m.ts?new Date(m.ts.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'';
      const imgHtml=m.image?`<img class="msg-img" src="${m.image}" onclick="openLightbox(this.src)">`:''
      const cached=transCache[d.id];
      const transHtml=cached?`<div class="msg-translation show">${escHtml(cached)}</div>`:`<div class="msg-translation" id="trans-${d.id}"></div>`;
      const hint=m.text?`<div class="translate-hint">${t('tapTranslate')}</div>`:'';
      return`<div class="msg ${isOwn?'own':''}"><div class="msg-avatar"><div class="avatar">${ini}</div></div><div class="msg-bubble" onclick="translateMsg('${d.id}','${escAttr(m.text||'')}')">${isOwn?'':`<div class="msg-author">${escHtml(m.author)}</div>`}${m.text?`<div class="msg-text">${escHtml(m.text)}</div>`:''}${imgHtml}${transHtml}${hint}<div class="msg-time">${time}</div></div></div>`;
    }).join('');
    if(atBottom)area.scrollTop=area.scrollHeight;
    if(currentRoomId===roomId)setDoc(doc(db,'rooms',roomId),{msgCount:snap.size},{merge:true});
  });
}

// â”€â”€ Translation â”€â”€
async function translateMsg(msgId,text){
  if(!text||!text.trim())return;
  const el=document.getElementById('trans-'+msgId);if(!el)return;
  if(el.classList.contains('show')){el.classList.remove('show');return;}
  if(transCache[msgId]){el.textContent=transCache[msgId];el.classList.add('show');return;}
  const lang=detectLang(text);
  const pair=lang==='ar'?'ar|en':`${lang}|ar`;
  el.innerHTML=`<span class="spin"></span>${t('translating')}`;el.classList.add('show');
  try{
    const res=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${pair}`);
    const data=await res.json();
    const result=data.responseData?.translatedText;
    if(result&&result!==text){transCache[msgId]=result;el.textContent=result;}
    else el.textContent=lang==='ar'?'Translation unavailable':'Ø§Ù„ØªØ±Ø¬Ù…Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø©';
  }catch(e){el.textContent=lang==='ar'?'Translation failed':'ÙØ´Ù„ Ø§Ù„ØªØ±Ø¬Ù…Ø©';}
}

// â”€â”€ Send â”€â”€
async function sendMessage(){
  const text=document.getElementById('msg-input').value.trim(),img=imageData;
  if(!text&&!img)return;if(!currentUser||!currentRoomId)return;
  document.getElementById('msg-input').value='';document.getElementById('msg-input').style.height='auto';clearImagePreview();
  await addDoc(collection(db,'rooms',currentRoomId,'messages'),{type:'user',author:currentUser.displayName||currentUser.email,authorId:currentUser.uid,text:text||'',image:img||null,ts:serverTimestamp()});
}

// â”€â”€ Image â”€â”€
function handleImageSelect(e){
  const file=e.target.files[0];if(!file)return;
  if(file.size>3*1024*1024){alert(t('errImg'));return;}
  const reader=new FileReader();
  reader.onload=ev=>{imageData=ev.target.result;document.getElementById('img-preview-thumb').src=ev.target.result;document.getElementById('img-preview-wrap').classList.add('show');};
  reader.readAsDataURL(file);e.target.value='';
}
function clearImagePreview(){imageData=null;document.getElementById('img-preview-wrap').classList.remove('show');document.getElementById('img-preview-thumb').src='';}

// â”€â”€ Modal close on backdrop â”€â”€
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.add('hidden');}));
document.getElementById('login-password').addEventListener('keydown',e=>{if(e.key==='Enter')login();});
document.getElementById('join-pass-input').addEventListener('keydown',e=>{if(e.key==='Enter')joinRoomWithPassword();});

// â”€â”€ Init â”€â”€
applyLang();
</script>
</body>
</html>
