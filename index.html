<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ŸÖÿ¨ŸÑÿ≥ - Arabian Chat</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap');
  :root {
    --gold:#c9a84c;--gold2:#f0d080;--gold3:#8b6914;
    --dark:#0d0a05;--dark2:#1a1408;--dark3:#241c0c;--dark4:#2e2410;
    --border:rgba(201,168,76,0.3);--border2:rgba(201,168,76,0.6);
    --text:#e8d5a3;--text2:#b8a070;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Lora',serif;background:var(--dark);color:var(--text);min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;background-image:radial-gradient(ellipse at 20% 50%,rgba(201,168,76,0.04) 0%,transparent 60%),radial-gradient(ellipse at 80% 50%,rgba(201,168,76,0.04) 0%,transparent 60%),url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none'%3E%3Cg fill='%23c9a84c' fill-opacity='0.03'%3E%3Cpath d='M30 0l5 10 11-3-6 9 6 9-11-3-5 10-5-10-11 3 6-9-6-9 11 3z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");pointer-events:none;z-index:0;}
  #app{position:relative;z-index:1;}
  header{background:linear-gradient(180deg,rgba(10,7,2,0.98),rgba(15,11,4,0.95));border-bottom:1px solid var(--border2);padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(201,168,76,0.15);}
  .logo{font-family:'Cinzel',serif;font-size:1.6rem;font-weight:700;background:linear-gradient(135deg,var(--gold3),var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:3px;cursor:pointer;}
  .logo-sub{font-size:0.65rem;letter-spacing:5px;display:block;font-family:'Lora',serif;font-style:italic;-webkit-text-fill-color:var(--text2);margin-top:-4px;}
  .header-right{display:flex;align-items:center;gap:12px;}
  .user-badge{display:flex;align-items:center;gap:8px;background:var(--dark3);border:1px solid var(--border);border-radius:24px;padding:6px 14px 6px 8px;font-size:0.85rem;color:var(--text2);}
  .avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--gold3),var(--gold));display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:var(--dark);flex-shrink:0;}
  .btn{font-family:'Lora',serif;border:none;cursor:pointer;border-radius:6px;font-size:0.9rem;transition:all 0.2s;}
  .btn-gold{background:linear-gradient(135deg,var(--gold3),var(--gold));color:var(--dark);padding:10px 20px;font-weight:600;border:1px solid var(--gold2);}
  .btn-gold:hover{background:linear-gradient(135deg,var(--gold),var(--gold2));transform:translateY(-1px);box-shadow:0 4px 15px rgba(201,168,76,0.3);}
  .btn-gold:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
  .btn-outline{background:transparent;color:var(--gold);padding:9px 18px;border:1px solid var(--border2);}
  .btn-outline:hover{background:rgba(201,168,76,0.1);}
  .btn-danger{background:rgba(192,57,43,0.15);color:#e74c3c;padding:7px 14px;border:1px solid rgba(192,57,43,0.3);font-size:0.8rem;}
  .btn-danger:hover{background:rgba(192,57,43,0.3);}
  .btn-sm{padding:6px 14px;font-size:0.82rem;}
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px;backdrop-filter:blur(4px);}
  .modal-overlay.hidden{display:none;}
  .modal{background:linear-gradient(160deg,var(--dark3),var(--dark2));border:1px solid var(--border2);border-radius:12px;padding:32px;width:100%;max-width:440px;box-shadow:0 20px 60px rgba(0,0,0,0.8),0 0 40px rgba(201,168,76,0.1);position:relative;}
  .modal::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);border-radius:12px 12px 0 0;}
  .modal h2{font-family:'Cinzel',serif;color:var(--gold);text-align:center;margin-bottom:24px;font-size:1.4rem;letter-spacing:2px;}
  .ornament{text-align:center;color:var(--gold3);margin:-16px 0 16px;font-size:1.2rem;letter-spacing:8px;}
  .form-group{margin-bottom:16px;}
  .form-group label{display:block;color:var(--text2);font-size:0.82rem;margin-bottom:6px;letter-spacing:1px;text-transform:uppercase;}
  input[type=text],input[type=password],input[type=email],textarea{width:100%;background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:6px;padding:10px 14px;color:var(--text);font-family:'Lora',serif;font-size:0.9rem;transition:border-color 0.2s;outline:none;}
  input:focus,textarea:focus{border-color:var(--gold);box-shadow:0 0 0 2px rgba(201,168,76,0.1);}
  .form-actions{display:flex;gap:10px;margin-top:20px;}
  .form-actions .btn{flex:1;}
  .error-msg{color:#e74c3c;font-size:0.8rem;margin-top:8px;display:none;}
  .error-msg.show{display:block;}
  .divider{text-align:center;color:var(--text2);font-size:0.8rem;margin:16px 0;position:relative;}
  .divider::before,.divider::after{content:'';position:absolute;top:50%;width:38%;height:1px;background:var(--border);}
  .divider::before{left:0;}.divider::after{right:0;}
  #page-home{padding:32px 24px;max-width:1100px;margin:0 auto;}
  .home-hero{text-align:center;padding:40px 0 48px;}
  .home-hero h1{font-family:'Cinzel',serif;font-size:clamp(1.8rem,5vw,3rem);background:linear-gradient(135deg,var(--gold3),var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;letter-spacing:4px;}
  .home-hero p{color:var(--text2);font-style:italic;font-size:1rem;margin-bottom:32px;}
  .hero-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;}
  .search-bar{display:flex;gap:10px;margin-bottom:32px;}
  .search-bar input{flex:1;background:rgba(0,0,0,0.5);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-family:'Lora',serif;font-size:0.95rem;outline:none;}
  .search-bar input:focus{border-color:var(--gold);}
  .search-bar input::placeholder{color:var(--text2);}
  .section-title{font-family:'Cinzel',serif;color:var(--gold);font-size:1rem;letter-spacing:3px;text-transform:uppercase;margin-bottom:20px;padding-bottom:8px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
  .rooms-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px;}
  .room-card{background:linear-gradient(160deg,var(--dark3),var(--dark2));border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.25s;position:relative;overflow:hidden;}
  .room-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);opacity:0;transition:opacity 0.25s;}
  .room-card:hover{border-color:var(--border2);transform:translateY(-3px);box-shadow:0 8px 30px rgba(201,168,76,0.15);}
  .room-card:hover::before{opacity:1;}
  .room-card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
  .room-name{font-family:'Cinzel',serif;color:var(--gold);font-size:1rem;letter-spacing:1px;}
  .room-desc{color:var(--text2);font-size:0.85rem;font-style:italic;margin-bottom:12px;line-height:1.5;}
  .room-meta{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
  .room-tag{font-size:0.72rem;letter-spacing:1px;text-transform:uppercase;padding:3px 10px;border-radius:20px;background:rgba(201,168,76,0.08);border:1px solid var(--border);color:var(--text2);}
  .empty-state{text-align:center;padding:60px 20px;color:var(--text2);grid-column:1/-1;}
  .empty-state .icon{font-size:3rem;margin-bottom:16px;opacity:0.5;}
  #page-chat{display:flex;flex-direction:column;height:calc(100vh - 64px);}
  .chat-header{background:linear-gradient(180deg,rgba(10,7,2,0.98),rgba(20,14,4,0.95));border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
  .chat-room-name{font-family:'Cinzel',serif;color:var(--gold);font-size:1.1rem;letter-spacing:2px;}
  .chat-room-meta{color:var(--text2);font-size:0.8rem;margin-top:2px;}
  .chat-header-actions{display:flex;gap:8px;}
  .messages-area{flex:1;overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:12px;}
  .messages-area::-webkit-scrollbar{width:5px;}
  .messages-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
  .msg{display:flex;gap:10px;align-items:flex-end;max-width:70%;}
  .msg.own{align-self:flex-end;flex-direction:row-reverse;}
  .msg.system{align-self:center;max-width:100%;}
  .msg-avatar .avatar{width:32px;height:32px;font-size:0.75rem;}
  .msg-bubble{background:linear-gradient(160deg,var(--dark3),var(--dark4));border:1px solid var(--border);border-radius:12px 12px 12px 4px;padding:10px 14px;max-width:100%;}
  .msg.own .msg-bubble{background:linear-gradient(160deg,rgba(139,105,20,0.25),rgba(90,65,10,0.3));border-color:rgba(201,168,76,0.3);border-radius:12px 12px 4px 12px;}
  .msg.system .msg-bubble{background:rgba(201,168,76,0.06);border-color:var(--border);border-radius:20px;padding:6px 16px;text-align:center;}
  .msg-author{font-size:0.75rem;color:var(--gold);margin-bottom:4px;font-weight:600;}
  .msg-text{font-size:0.9rem;line-height:1.5;word-break:break-word;}
  .msg.system .msg-text{font-size:0.78rem;color:var(--text2);font-style:italic;}
  .msg-time{font-size:0.68rem;color:var(--text2);margin-top:4px;text-align:right;}
  .msg-img{max-width:280px;max-height:280px;border-radius:8px;display:block;margin-top:6px;cursor:pointer;}
  .chat-input-area{background:rgba(10,7,2,0.97);border-top:1px solid var(--border);padding:16px 20px;flex-shrink:0;}
  .chat-input-row{display:flex;gap:10px;align-items:flex-end;background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:10px;padding:8px 12px;transition:border-color 0.2s;}
  .chat-input-row:focus-within{border-color:var(--gold);}
  #msg-input{flex:1;background:transparent;border:none;color:var(--text);font-family:'Lora',serif;font-size:0.9rem;resize:none;outline:none;max-height:120px;min-height:36px;line-height:1.5;padding-top:4px;}
  .img-upload-btn{background:none;border:none;cursor:pointer;color:var(--gold3);font-size:1.3rem;padding:4px 6px;transition:color 0.2s;line-height:1;}
  .img-upload-btn:hover{color:var(--gold);}
  .send-btn{background:linear-gradient(135deg,var(--gold3),var(--gold));border:none;border-radius:6px;cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;color:var(--dark);font-size:1rem;transition:all 0.2s;flex-shrink:0;}
  .send-btn:hover{background:linear-gradient(135deg,var(--gold),var(--gold2));transform:scale(1.05);}
  .image-preview-wrap{display:none;padding:8px 0;position:relative;width:fit-content;}
  .image-preview-wrap.show{display:block;}
  .image-preview-thumb{width:80px;height:80px;object-fit:cover;border-radius:6px;border:1px solid var(--border2);}
  .remove-preview{position:absolute;top:-6px;right:-6px;background:#c0392b;color:#fff;border:none;border-radius:50%;width:18px;height:18px;cursor:pointer;font-size:0.65rem;display:flex;align-items:center;justify-content:center;}
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.92);display:flex;align-items:center;justify-content:center;z-index:300;cursor:zoom-out;backdrop-filter:blur(8px);}
  .lightbox.hidden{display:none;}
  .lightbox img{max-width:90vw;max-height:90vh;border-radius:8px;}
  .page{display:none;}
  .page.active{display:block;}
  #page-chat.active{display:flex;}
  .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(201,168,76,0.3);border-top-color:var(--gold);border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;margin-right:6px;}
  @keyframes spin{to{transform:rotate(360deg);}}
  .loading-screen{position:fixed;inset:0;background:var(--dark);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;gap:16px;}
  .loading-screen h2{font-family:'Cinzel',serif;color:var(--gold);letter-spacing:4px;}
  .loading-screen p{color:var(--text2);font-style:italic;}
  @media(max-width:600px){header{padding:0 14px;}#page-home{padding:20px 14px;}.msg{max-width:88%;}.messages-area{padding:14px;}.chat-input-area{padding:12px;}}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="logo" onclick="navigate('home')">ŸÖÿ¨ŸÑÿ≥<span class="logo-sub">Unmarried Gathering</span></div>
    <div class="header-right" id="header-right">
      <button class="btn btn-outline btn-sm" onclick="showModal('login')">Sign In</button>
      <button class="btn btn-gold btn-sm" onclick="showModal('register')">Join</button>
    </div>
  </header>

  <div id="page-home" class="page active">
    <div class="home-hero">
      <h1>Enter the Majlis</h1>
      <p>Where conversations flow like desert winds...</p>
      <div class="hero-actions" id="hero-actions">
        <button class="btn btn-gold" onclick="showModal('register')">‚ú¶ Create Account</button>
        <button class="btn btn-outline" onclick="showModal('login')">Enter the Hall</button>
      </div>
    </div>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="üîç  Search gathering rooms..." oninput="filterRooms()">
    </div>
    <div class="section-title">
      <span>‚ú¶ Open Gatherings</span>
      <button class="btn btn-gold btn-sm" id="create-room-btn" style="display:none" onclick="showModal('create-room')">+ New Room</button>
    </div>
    <div class="rooms-grid" id="rooms-grid"><div class="empty-state"><div class="icon">üïå</div><p>Loading gatherings...</p></div></div>
  </div>

  <div id="page-chat" class="page">
    <div class="chat-header">
      <div>
        <div class="chat-room-name" id="chat-room-name">Room</div>
        <div class="chat-room-meta" id="chat-room-meta"></div>
      </div>
      <div class="chat-header-actions">
        <button class="btn btn-outline btn-sm" onclick="leaveRoom()">‚Üê Leave</button>
        <button class="btn btn-danger btn-sm" id="delete-room-btn" style="display:none" onclick="deleteRoom()">Delete Room</button>
      </div>
    </div>
    <div class="messages-area" id="messages-area"></div>
    <div class="chat-input-area">
      <div class="image-preview-wrap" id="img-preview-wrap">
        <img id="img-preview-thumb" class="image-preview-thumb" src="" alt="">
        <button class="remove-preview" onclick="clearImagePreview()">‚úï</button>
      </div>
      <div class="chat-input-row">
        <button class="img-upload-btn" onclick="document.getElementById('img-file-input').click()" title="Upload image">üñº</button>
        <input type="file" id="img-file-input" accept="image/*" style="display:none" onchange="handleImageSelect(event)">
        <textarea id="msg-input" placeholder="Write your message..." rows="1" onkeydown="handleMsgKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <div class="lightbox hidden" id="lightbox" onclick="closeLightbox()">
    <img id="lightbox-img" src="" alt="">
  </div>

  <!-- Register -->
  <div class="modal-overlay hidden" id="modal-register">
    <div class="modal">
      <h2>Join the Majlis</h2><div class="ornament">‚ú¶ ‚óÜ ‚ú¶</div>
      <div class="form-group"><label>Username</label><input type="text" id="reg-username" placeholder="Choose your name..."></div>
      <div class="form-group"><label>Email</label><input type="email" id="reg-email" placeholder="your@email.com"></div>
      <div class="form-group"><label>Password</label><input type="password" id="reg-password" placeholder="Secret word..."></div>
      <div class="error-msg" id="reg-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('register')">Cancel</button>
        <button class="btn btn-gold" id="reg-btn" onclick="register()">Create Account</button>
      </div>
      <div class="divider">already a member?</div>
      <button class="btn btn-outline" style="width:100%" onclick="hideModal('register');showModal('login')">Sign In Instead</button>
    </div>
  </div>

  <!-- Login -->
  <div class="modal-overlay hidden" id="modal-login">
    <div class="modal">
      <h2>Enter the Hall</h2><div class="ornament">‚ú¶ ‚óÜ ‚ú¶</div>
      <div class="form-group"><label>Email</label><input type="email" id="login-email" placeholder="your@email.com"></div>
      <div class="form-group"><label>Password</label><input type="password" id="login-password" placeholder="Secret word..."></div>
      <div class="error-msg" id="login-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('login')">Cancel</button>
        <button class="btn btn-gold" id="login-btn" onclick="login()">Enter</button>
      </div>
      <div class="divider">new here?</div>
      <button class="btn btn-outline" style="width:100%" onclick="hideModal('login');showModal('register')">Create Account</button>
    </div>
  </div>

  <!-- Create Room -->
  <div class="modal-overlay hidden" id="modal-create-room">
    <div class="modal">
      <h2>Open a Gathering</h2><div class="ornament">‚ú¶ ‚óÜ ‚ú¶</div>
      <div class="form-group"><label>Room Name</label><input type="text" id="room-name-input" placeholder="Name your gathering..."></div>
      <div class="form-group"><label>Description</label><input type="text" id="room-desc-input" placeholder="Describe the gathering..."></div>
      <div class="form-group"><label>Password (optional)</label><input type="password" id="room-pass-input" placeholder="Leave blank for open room..."></div>
      <div class="error-msg" id="room-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('create-room')">Cancel</button>
        <button class="btn btn-gold" id="create-room-btn2" onclick="createRoom()">Open Room</button>
      </div>
    </div>
  </div>

  <!-- Join Room -->
  <div class="modal-overlay hidden" id="modal-join-room">
    <div class="modal">
      <h2>Enter the Gathering</h2><div class="ornament">‚ú¶ ‚óÜ ‚ú¶</div>
      <p style="color:var(--text2);text-align:center;margin-bottom:20px;font-style:italic">This gathering is protected.</p>
      <div class="form-group"><label>Password</label><input type="password" id="join-pass-input" placeholder="Secret word..."></div>
      <div class="error-msg" id="join-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('join-room')">Cancel</button>
        <button class="btn btn-gold" onclick="joinRoomWithPassword()">Enter</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBEyS6QjmOpS-DOKDdO1h-3qEKca79_HoA",
  authDomain: "majlis-61b79.firebaseapp.com",
  projectId: "majlis-61b79",
  storageBucket: "majlis-61b79.firebasestorage.app",
  messagingSenderId: "633132324226",
  appId: "1:633132324226:web:160eb3dfe90e03d052eb9b"
};

const fbApp = initializeApp(firebaseConfig);
const auth = getAuth(fbApp);
const db = getFirestore(fbApp);

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let currentUser = null;
let allRooms = [];
let currentRoomId = null;
let pendingRoomId = null;
let imageData = null;
let msgUnsub = null;
let roomsUnsub = null;

// ‚îÄ‚îÄ Auth state ‚îÄ‚îÄ
onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    updateHeaderUI();
  } else {
    currentUser = null;
    updateHeaderUI();
  }
  listenRooms();
});

// ‚îÄ‚îÄ Register ‚îÄ‚îÄ
window.register = async () => {
  const username = v('reg-username').trim();
  const email = v('reg-email').trim();
  const pass = v('reg-password');
  if (!username || !email || !pass) return showError('reg-error','Please fill all fields.');
  if (pass.length < 6) return showError('reg-error','Password must be at least 6 characters.');
  setLoading('reg-btn', true);
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, { displayName: username });
    currentUser = cred.user;
    hideModal('register');
    clearFields(['reg-username','reg-email','reg-password']);
  } catch(e) {
    showError('reg-error', friendlyError(e.code));
  }
  setLoading('reg-btn', false);
};

// ‚îÄ‚îÄ Login ‚îÄ‚îÄ
window.login = async () => {
  const email = v('login-email').trim();
  const pass = v('login-password');
  if (!email || !pass) return showError('login-error','Please fill all fields.');
  setLoading('login-btn', true);
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    hideModal('login');
    clearFields(['login-email','login-password']);
  } catch(e) {
    showError('login-error', friendlyError(e.code));
  }
  setLoading('login-btn', false);
};

// ‚îÄ‚îÄ Logout ‚îÄ‚îÄ
window.logout = async () => {
  leaveRoom();
  await signOut(auth);
};

function updateHeaderUI() {
  const el = document.getElementById('header-right');
  const heroActions = document.getElementById('hero-actions');
  const createBtn = document.getElementById('create-room-btn');
  if (currentUser) {
    const initials = (currentUser.displayName || currentUser.email).substring(0,2).toUpperCase();
    el.innerHTML = `<div class="user-badge"><div class="avatar">${initials}</div><span>${escHtml(currentUser.displayName || currentUser.email)}</span></div><button class="btn btn-outline btn-sm" onclick="logout()">Leave</button>`;
    heroActions.innerHTML = `<button class="btn btn-gold" onclick="showModal('create-room')">‚ú¶ Open New Room</button>`;
    createBtn.style.display = 'inline-flex';
  } else {
    el.innerHTML = `<button class="btn btn-outline btn-sm" onclick="showModal('login')">Sign In</button><button class="btn btn-gold btn-sm" onclick="showModal('register')">Join</button>`;
    heroActions.innerHTML = `<button class="btn btn-gold" onclick="showModal('register')">‚ú¶ Create Account</button><button class="btn btn-outline" onclick="showModal('login')">Enter the Hall</button>`;
    createBtn.style.display = 'none';
  }
}

// ‚îÄ‚îÄ Rooms listener ‚îÄ‚îÄ
function listenRooms() {
  if (roomsUnsub) roomsUnsub();
  const q = query(collection(db,'rooms'), orderBy('createdAt','desc'));
  roomsUnsub = onSnapshot(q, snap => {
    allRooms = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderRooms();
  });
}

function renderRooms() {
  const grid = document.getElementById('rooms-grid');
  const query = (v('search-input')||'').toLowerCase();
  let arr = allRooms;
  if (query) arr = arr.filter(r => r.name.toLowerCase().includes(query) || (r.desc||'').toLowerCase().includes(query));
  if (!arr.length) {
    grid.innerHTML = `<div class="empty-state"><div class="icon">üïå</div><p>${query ? 'No rooms found.' : 'No gatherings yet. Be the first!'}</p></div>`;
    return;
  }
  grid.innerHTML = arr.map(r => {
    const lock = r.password ? 'üîí' : 'üîì';
    const isOwner = currentUser && currentUser.uid === r.ownerId;
    return `<div class="room-card" onclick="tryEnterRoom('${r.id}')">
      <div class="room-card-header"><div class="room-name">${escHtml(r.name)}</div><span>${lock}</span></div>
      <div class="room-desc">${escHtml(r.desc||'A gathering place for conversation...')}</div>
      <div class="room-meta">
        <span class="room-tag">by ${escHtml(r.ownerName)}</span>
        <span class="room-tag">${r.msgCount||0} messages</span>
        ${isOwner?'<span class="room-tag" style="border-color:rgba(201,168,76,0.5);color:var(--gold)">Your Room</span>':''}
      </div>
    </div>`;
  }).join('');
}

window.filterRooms = renderRooms;

// ‚îÄ‚îÄ Create Room ‚îÄ‚îÄ
window.createRoom = async () => {
  if (!currentUser) return;
  const name = v('room-name-input').trim();
  const desc = v('room-desc-input').trim();
  const pass = v('room-pass-input');
  if (!name) return showError('room-error','Please enter a room name.');
  setLoading('create-room-btn2', true);
  try {
    await addDoc(collection(db,'rooms'), {
      name, desc, password: pass,
      ownerId: currentUser.uid,
      ownerName: currentUser.displayName || currentUser.email,
      createdAt: serverTimestamp(),
      msgCount: 0
    });
    hideModal('create-room');
    clearFields(['room-name-input','room-desc-input','room-pass-input']);
  } catch(e) { showError('room-error', e.message); }
  setLoading('create-room-btn2', false);
};

// ‚îÄ‚îÄ Enter Room ‚îÄ‚îÄ
window.tryEnterRoom = (id) => {
  if (!currentUser) { showModal('login'); return; }
  const room = allRooms.find(r => r.id === id);
  if (!room) return;
  if (room.password) { pendingRoomId = id; showModal('join-room'); }
  else enterRoom(id);
};

window.joinRoomWithPassword = () => {
  const room = allRooms.find(r => r.id === pendingRoomId);
  if (!room) return;
  if (v('join-pass-input') !== room.password) return showError('join-error','Incorrect password.');
  hideModal('join-room');
  clearFields(['join-pass-input']);
  enterRoom(pendingRoomId);
};

function enterRoom(id) {
  currentRoomId = id;
  const room = allRooms.find(r => r.id === id);
  document.getElementById('chat-room-name').textContent = room.name;
  document.getElementById('chat-room-meta').textContent = (room.desc||'') + (room.password ? '  üîí Protected' : '  üîì Open');
  document.getElementById('delete-room-btn').style.display = (currentUser.uid === room.ownerId) ? 'inline-flex' : 'none';
  navigate('chat');
  listenMessages(id);
  // system message
  addDoc(collection(db,'rooms',id,'messages'), {
    type:'system', text:`${currentUser.displayName||currentUser.email} has entered the gathering`,
    ts: serverTimestamp()
  });
}

window.leaveRoom = () => {
  if (msgUnsub) { msgUnsub(); msgUnsub = null; }
  currentRoomId = null;
  document.getElementById('messages-area').innerHTML = '';
  navigate('home');
};

window.deleteRoom = async () => {
  const room = allRooms.find(r => r.id === currentRoomId);
  if (!room || room.ownerId !== currentUser.uid) return;
  if (!confirm(`Delete "${room.name}"? This cannot be undone.`)) return;
  // delete messages subcollection
  const msgs = await getDocs(collection(db,'rooms',currentRoomId,'messages'));
  for (const m of msgs.docs) await deleteDoc(m.ref);
  await deleteDoc(doc(db,'rooms',currentRoomId));
  leaveRoom();
};

// ‚îÄ‚îÄ Messages ‚îÄ‚îÄ
function listenMessages(roomId) {
  if (msgUnsub) msgUnsub();
  const q = query(collection(db,'rooms',roomId,'messages'), orderBy('ts','asc'));
  msgUnsub = onSnapshot(q, snap => {
    const area = document.getElementById('messages-area');
    const atBottom = area.scrollHeight - area.clientHeight <= area.scrollTop + 60;
    area.innerHTML = snap.docs.map(d => {
      const m = d.data();
      if (m.type === 'system') return `<div class="msg system"><div class="msg-bubble"><div class="msg-text">${escHtml(m.text)}</div></div></div>`;
      const isOwn = m.authorId === currentUser.uid;
      const initials = (m.author||'?').substring(0,2).toUpperCase();
      const time = m.ts ? new Date(m.ts.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
      const imgHtml = m.image ? `<img class="msg-img" src="${m.image}" onclick="openLightbox(this.src)">` : '';
      return `<div class="msg ${isOwn?'own':''}">
        <div class="msg-avatar"><div class="avatar">${initials}</div></div>
        <div class="msg-bubble">
          ${isOwn?'':`<div class="msg-author">${escHtml(m.author)}</div>`}
          ${m.text?`<div class="msg-text">${escHtml(m.text)}</div>`:''}
          ${imgHtml}
          <div class="msg-time">${time}</div>
        </div>
      </div>`;
    }).join('');
    if (atBottom) area.scrollTop = area.scrollHeight;
    // update msg count
    if (currentRoomId === roomId) {
      const roomRef = doc(db,'rooms',roomId);
      setDoc(roomRef, { msgCount: snap.size }, { merge: true });
    }
  });
}

window.sendMessage = async () => {
  const text = document.getElementById('msg-input').value.trim();
  const img = imageData;
  if (!text && !img) return;
  if (!currentUser || !currentRoomId) return;
  document.getElementById('msg-input').value = '';
  document.getElementById('msg-input').style.height = 'auto';
  clearImagePreview();
  await addDoc(collection(db,'rooms',currentRoomId,'messages'), {
    type:'user',
    author: currentUser.displayName || currentUser.email,
    authorId: currentUser.uid,
    text: text || '',
    image: img || null,
    ts: serverTimestamp()
  });
};

// ‚îÄ‚îÄ Image ‚îÄ‚îÄ
window.handleImageSelect = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 3*1024*1024) { alert('Image must be under 3MB.'); return; }
  const reader = new FileReader();
  reader.onload = ev => {
    imageData = ev.target.result;
    document.getElementById('img-preview-thumb').src = ev.target.result;
    document.getElementById('img-preview-wrap').classList.add('show');
  };
  reader.readAsDataURL(file);
  e.target.value = '';
};

window.clearImagePreview = () => {
  imageData = null;
  document.getElementById('img-preview-wrap').classList.remove('show');
  document.getElementById('img-preview-thumb').src = '';
};

window.openLightbox = src => { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').classList.remove('hidden'); };
window.closeLightbox = () => document.getElementById('lightbox').classList.add('hidden');

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
window.navigate = page => {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
};

// ‚îÄ‚îÄ Modals ‚îÄ‚îÄ
window.showModal = id => document.getElementById('modal-'+id).classList.remove('hidden');
window.hideModal = id => { document.getElementById('modal-'+id).classList.add('hidden'); clearErrors(); };
document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if(e.target===o) o.classList.add('hidden'); }));

// ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ
window.handleMsgKey = e => { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} };
window.autoResize = el => { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; };
document.getElementById('login-password').addEventListener('keydown', e => { if(e.key==='Enter') login(); });
document.getElementById('join-pass-input').addEventListener('keydown', e => { if(e.key==='Enter') joinRoomWithPassword(); });

// ‚îÄ‚îÄ Utils ‚îÄ‚îÄ
function v(id){ const el=document.getElementById(id); return el?el.value:''; }
function clearFields(ids){ ids.forEach(id=>{const el=document.getElementById(id);if(el)el.value='';}); }
function showError(id,msg){ const el=document.getElementById(id); if(el){el.textContent=msg;el.classList.add('show');} }
function clearErrors(){ document.querySelectorAll('.error-msg').forEach(e=>e.classList.remove('show')); }
function escHtml(s){ if(!s)return''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function setLoading(id, on){ const el=document.getElementById(id); if(!el)return; el.disabled=on; el.innerHTML=on?`<span class="spinner"></span>Loading...`:el.getAttribute('data-label')||el.textContent; }
function friendlyError(code){
  const map={'auth/email-already-in-use':'Email already registered.','auth/invalid-email':'Invalid email address.','auth/weak-password':'Password too weak (min 6 chars).','auth/user-not-found':'No account with this email.','auth/wrong-password':'Incorrect password.','auth/invalid-credential':'Incorrect email or password.'};
  return map[code]||'Something went wrong. Try again.';
}
</script>
</body>
</html>
