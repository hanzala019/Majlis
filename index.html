<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø¬Ù„Ø³ - Arabian Chat</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&family=Amiri:ital,wght@0,400;0,700;1,400&display=swap');
:root{
  --gold:#c9a84c;--gold2:#f0d080;--gold3:#8b6914;
  --dark:#0d0a05;--dark2:#1a1408;--dark3:#241c0c;--dark4:#2e2410;
  --border:rgba(201,168,76,0.3);--border2:rgba(201,168,76,0.6);
  --text:#e8d5a3;--text2:#b8a070;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Lora',serif;background:var(--dark);color:var(--text);min-height:100vh;overflow-x:hidden;}

/* â”€â”€ Geometric SVG background â”€â”€ */
body::before{
  content:'';position:fixed;inset:0;
  background-image:
    radial-gradient(ellipse at 20% 50%,rgba(201,168,76,0.05) 0%,transparent 60%),
    radial-gradient(ellipse at 80% 50%,rgba(201,168,76,0.05) 0%,transparent 60%),
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cg fill='none' stroke='%23c9a84c' stroke-width='0.4' stroke-opacity='0.07'%3E%3Cpolygon points='60,5 72,35 105,35 80,55 90,85 60,67 30,85 40,55 15,35 48,35'/%3E%3Crect x='30' y='30' width='60' height='60' transform='rotate(45 60 60)'/%3E%3Ccircle cx='60' cy='60' r='28'/%3E%3Cpolygon points='60,20 68,44 95,44 74,59 81,83 60,69 39,83 46,59 25,44 52,44'/%3E%3C/g%3E%3C/svg%3E");
  pointer-events:none;z-index:0;
}

/* Drifting sand particles */
.particle{position:fixed;border-radius:50%;background:rgba(201,168,76,0.15);pointer-events:none;z-index:0;animation:drift linear infinite;}
@keyframes drift{0%{transform:translateY(100vh) translateX(0) rotate(0deg);opacity:0;}10%{opacity:1;}90%{opacity:0.5;}100%{transform:translateY(-10vh) translateX(60px) rotate(360deg);opacity:0;}}

#app{position:relative;z-index:1;}

/* â”€â”€ Header â”€â”€ */
header{
  background:linear-gradient(180deg,rgba(8,5,1,0.99),rgba(15,11,4,0.97));
  border-bottom:2px solid transparent;
  border-image:linear-gradient(90deg,transparent,var(--gold),transparent) 1;
  padding:0 24px;display:flex;align-items:center;justify-content:space-between;
  height:70px;position:sticky;top:0;z-index:100;
  box-shadow:0 2px 30px rgba(201,168,76,0.2);
}
.logo{font-family:'Amiri',serif;font-size:2rem;font-weight:700;background:linear-gradient(135deg,var(--gold3),var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;cursor:pointer;line-height:1;}
.logo-sub{font-size:0.6rem;letter-spacing:5px;display:block;font-family:'Lora',serif;font-style:italic;-webkit-text-fill-color:var(--text2);margin-top:2px;text-transform:uppercase;}
.header-center{display:flex;flex-direction:column;align-items:center;gap:2px;}
.hijri-date{font-family:'Amiri',serif;font-size:0.85rem;color:var(--gold3);letter-spacing:1px;}
.header-right{display:flex;align-items:center;gap:12px;}
.user-badge{display:flex;align-items:center;gap:8px;background:var(--dark3);border:1px solid var(--border);border-radius:24px;padding:6px 14px 6px 8px;font-size:0.85rem;color:var(--text2);}
.avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--gold3),var(--gold));display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:var(--dark);flex-shrink:0;}

/* â”€â”€ Buttons â”€â”€ */
.btn{font-family:'Lora',serif;border:none;cursor:pointer;border-radius:6px;font-size:0.9rem;transition:all 0.2s;}
.btn-gold{background:linear-gradient(135deg,var(--gold3),var(--gold));color:var(--dark);padding:10px 20px;font-weight:600;border:1px solid var(--gold2);}
.btn-gold:hover{background:linear-gradient(135deg,var(--gold),var(--gold2));transform:translateY(-1px);box-shadow:0 4px 15px rgba(201,168,76,0.3);}
.btn-gold:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
.btn-outline{background:transparent;color:var(--gold);padding:9px 18px;border:1px solid var(--border2);}
.btn-outline:hover{background:rgba(201,168,76,0.1);}
.btn-danger{background:rgba(192,57,43,0.15);color:#e74c3c;padding:7px 14px;border:1px solid rgba(192,57,43,0.3);font-size:0.8rem;}
.btn-danger:hover{background:rgba(192,57,43,0.3);}
.btn-sm{padding:6px 14px;font-size:0.82rem;}

/* â”€â”€ Modals â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px;backdrop-filter:blur(6px);}
.modal-overlay.hidden{display:none;}
.modal{
  background:linear-gradient(160deg,var(--dark3),var(--dark2));
  border:1px solid var(--border2);border-radius:12px;
  padding:32px;width:100%;max-width:440px;
  box-shadow:0 20px 60px rgba(0,0,0,0.9),0 0 40px rgba(201,168,76,0.12);
  position:relative;overflow:hidden;
}
/* Geometric corner decorations */
.modal::before,.modal::after{content:'';position:absolute;}
.modal::before{top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
.modal-geo{position:absolute;top:8px;right:8px;width:40px;height:40px;opacity:0.15;}
.modal h2{font-family:'Amiri',serif;color:var(--gold);text-align:center;margin-bottom:6px;font-size:1.6rem;letter-spacing:2px;}
.ornament{text-align:center;color:var(--gold3);margin:0 0 20px;font-size:1rem;letter-spacing:8px;}
.form-group{margin-bottom:16px;}
.form-group label{display:block;color:var(--text2);font-size:0.8rem;margin-bottom:6px;letter-spacing:1px;text-transform:uppercase;}
input[type=text],input[type=password],input[type=email],textarea{width:100%;background:rgba(0,0,0,0.5);border:1px solid var(--border);border-radius:6px;padding:10px 14px;color:var(--text);font-family:'Lora',serif;font-size:0.9rem;transition:border-color 0.2s;outline:none;}
input:focus,textarea:focus{border-color:var(--gold);box-shadow:0 0 0 2px rgba(201,168,76,0.1);}
.form-actions{display:flex;gap:10px;margin-top:20px;}
.form-actions .btn{flex:1;}
.error-msg{color:#e74c3c;font-size:0.8rem;margin-top:8px;display:none;}
.error-msg.show{display:block;}
.divider{text-align:center;color:var(--text2);font-size:0.8rem;margin:16px 0;position:relative;}
.divider::before,.divider::after{content:'';position:absolute;top:50%;width:38%;height:1px;background:var(--border);}
.divider::before{left:0;}.divider::after{right:0;}

/* â”€â”€ Home â”€â”€ */
#page-home{padding:32px 24px;max-width:1100px;margin:0 auto;}
.home-hero{text-align:center;padding:40px 0 48px;position:relative;}
/* Arch frame around hero */
.hero-arch{
  display:inline-block;padding:32px 48px;position:relative;
  border:1px solid var(--border);
  border-radius:60% 60% 0 0 / 30% 30% 0 0;
  background:linear-gradient(180deg,rgba(201,168,76,0.04),transparent);
  margin-bottom:24px;
}
.hero-arch::before{content:'';position:absolute;inset:-8px;border:1px solid rgba(201,168,76,0.12);border-radius:60% 60% 0 0 / 30% 30% 0 0;}
.home-hero h1{font-family:'Amiri',serif;font-size:clamp(2rem,6vw,3.5rem);background:linear-gradient(135deg,var(--gold3),var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1.1;}
.home-hero h1 span{display:block;font-size:0.45em;letter-spacing:6px;font-family:'Lora',serif;font-style:italic;-webkit-text-fill-color:var(--text2);margin-top:4px;}
.hero-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:24px;}
.search-bar{display:flex;gap:10px;margin-bottom:32px;}
.search-bar input{flex:1;background:rgba(0,0,0,0.5);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-family:'Lora',serif;font-size:0.95rem;outline:none;}
.search-bar input:focus{border-color:var(--gold);}
.search-bar input::placeholder{color:var(--text2);}
.section-title{font-family:'Amiri',serif;color:var(--gold);font-size:1.2rem;letter-spacing:3px;margin-bottom:20px;padding-bottom:10px;display:flex;align-items:center;justify-content:space-between;position:relative;}
.section-title::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,var(--gold),transparent);}
.rooms-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;}

/* Room card with arch top */
.room-card{
  background:linear-gradient(170deg,var(--dark3),var(--dark2));
  border:1px solid var(--border);
  border-radius:50% 50% 8px 8px / 20% 20% 8px 8px;
  padding:28px 20px 20px;
  cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden;
}
.room-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);opacity:0;transition:opacity 0.3s;}
/* Geometric accent in corner */
.room-card::after{
  content:'';position:absolute;top:6px;right:10px;
  width:28px;height:28px;opacity:0.12;
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 28 28'%3E%3Cpolygon points='14,1 17,9 26,9 19,14 22,22 14,17 6,22 9,14 2,9 11,9' fill='%23c9a84c'/%3E%3C/svg%3E") center/contain no-repeat;
}
.room-card:hover{border-color:var(--border2);transform:translateY(-4px);box-shadow:0 12px 40px rgba(201,168,76,0.18);}
.room-card:hover::before{opacity:1;}
.room-card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
.room-name{font-family:'Amiri',serif;color:var(--gold);font-size:1.1rem;letter-spacing:1px;}
.room-desc{color:var(--text2);font-size:0.85rem;font-style:italic;margin-bottom:14px;line-height:1.6;}
.room-meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.room-tag{font-size:0.7rem;letter-spacing:1px;text-transform:uppercase;padding:3px 10px;border-radius:20px;background:rgba(201,168,76,0.07);border:1px solid var(--border);color:var(--text2);}
.empty-state{text-align:center;padding:60px 20px;color:var(--text2);grid-column:1/-1;}
.empty-state .icon{font-size:3rem;margin-bottom:16px;opacity:0.5;}

/* â”€â”€ Chat â”€â”€ */
#page-chat{display:flex;flex-direction:column;height:calc(100vh - 70px);}
.chat-header{background:linear-gradient(180deg,rgba(8,5,1,0.99),rgba(18,13,4,0.97));border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.chat-room-name{font-family:'Amiri',serif;color:var(--gold);font-size:1.2rem;letter-spacing:2px;}
.chat-room-meta{color:var(--text2);font-size:0.78rem;margin-top:2px;}
.chat-header-actions{display:flex;gap:8px;}
.messages-area{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:14px;background:linear-gradient(180deg,rgba(13,10,5,0.6),rgba(20,14,6,0.8));}
.messages-area::-webkit-scrollbar{width:4px;}
.messages-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* Arch message bubbles */
.msg{display:flex;gap:10px;align-items:flex-end;max-width:72%;}
.msg.own{align-self:flex-end;flex-direction:row-reverse;}
.msg.system{align-self:center;max-width:100%;}
.msg-avatar .avatar{width:34px;height:34px;font-size:0.75rem;}
.msg-bubble{
  background:linear-gradient(160deg,var(--dark3),var(--dark4));
  border:1px solid var(--border);
  /* Arch shape: rounded top, square bottom */
  border-radius:48% 48% 8px 8px / 18% 18% 8px 8px;
  padding:16px 14px 10px;
  max-width:100%;position:relative;
}
.msg.own .msg-bubble{
  background:linear-gradient(160deg,rgba(139,105,20,0.22),rgba(80,58,8,0.28));
  border-color:rgba(201,168,76,0.35);
}
.msg.system .msg-bubble{
  background:rgba(201,168,76,0.05);border-color:var(--border);
  border-radius:20px;padding:6px 20px;text-align:center;
}
/* Tiny star geo on bubble */
.msg-bubble::after{
  content:'âœ¦';position:absolute;top:4px;right:8px;
  font-size:0.45rem;color:var(--gold3);opacity:0.5;
}
.msg.system .msg-bubble::after{display:none;}
.msg-author{font-family:'Amiri',serif;font-size:0.82rem;color:var(--gold);margin-bottom:4px;font-weight:700;}
.msg-text{font-size:0.9rem;line-height:1.6;word-break:break-word;}
.msg.system .msg-text{font-size:0.78rem;color:var(--text2);font-style:italic;font-family:'Amiri',serif;}
.msg-time{font-size:0.65rem;color:var(--text2);margin-top:6px;text-align:right;font-family:monospace;}
.msg-img{max-width:260px;max-height:260px;border-radius:8px 8px 4px 4px;display:block;margin-top:8px;cursor:pointer;border:1px solid var(--border);}

/* Chat input */
.chat-input-area{background:rgba(8,5,1,0.98);border-top:1px solid var(--border);padding:16px 20px;flex-shrink:0;}
.chat-input-row{display:flex;gap:10px;align-items:flex-end;background:rgba(0,0,0,0.45);border:1px solid var(--border);border-radius:10px;padding:8px 12px;transition:border-color 0.2s;}
.chat-input-row:focus-within{border-color:var(--gold);}
#msg-input{flex:1;background:transparent;border:none;color:var(--text);font-family:'Lora',serif;font-size:0.9rem;resize:none;outline:none;max-height:120px;min-height:36px;line-height:1.5;padding-top:4px;}
#msg-input::placeholder{color:var(--text2);font-style:italic;}
.img-upload-btn{background:none;border:none;cursor:pointer;color:var(--gold3);font-size:1.3rem;padding:4px 6px;transition:color 0.2s;}
.img-upload-btn:hover{color:var(--gold);}
.send-btn{background:linear-gradient(135deg,var(--gold3),var(--gold));border:none;border-radius:50%;cursor:pointer;width:38px;height:38px;display:flex;align-items:center;justify-content:center;color:var(--dark);font-size:1.1rem;transition:all 0.2s;flex-shrink:0;}
.send-btn:hover{transform:scale(1.1);box-shadow:0 0 14px rgba(201,168,76,0.4);}
.image-preview-wrap{display:none;padding:8px 0;position:relative;width:fit-content;}
.image-preview-wrap.show{display:block;}
.image-preview-thumb{width:72px;height:72px;object-fit:cover;border-radius:6px;border:1px solid var(--border2);}
.remove-preview{position:absolute;top:-6px;right:-6px;background:#c0392b;color:#fff;border:none;border-radius:50%;width:18px;height:18px;cursor:pointer;font-size:0.65rem;display:flex;align-items:center;justify-content:center;}

/* Lightbox */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.93);display:flex;align-items:center;justify-content:center;z-index:300;cursor:zoom-out;backdrop-filter:blur(10px);}
.lightbox.hidden{display:none;}
.lightbox img{max-width:90vw;max-height:90vh;border-radius:8px;border:1px solid var(--border2);}

/* Misc */
.page{display:none;}.page.active{display:block;}#page-chat.active{display:flex;}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(201,168,76,0.3);border-top-color:var(--gold);border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;margin-right:6px;}
@keyframes spin{to{transform:rotate(360deg);}}
@media(max-width:600px){header{padding:0 12px;}.header-center{display:none;}#page-home{padding:16px 12px;}.msg{max-width:90%;}.messages-area{padding:14px;}.chat-input-area{padding:10px;}.hero-arch{padding:20px 24px;}}
</style>
</head>
<body>

<!-- Sand particles -->
<script>
for(let i=0;i<12;i++){
  const p=document.createElement('div');
  p.className='particle';
  const s=Math.random()*4+2;
  p.style.cssText=`width:${s}px;height:${s}px;left:${Math.random()*100}%;animation-duration:${Math.random()*20+15}s;animation-delay:${Math.random()*15}s;`;
  document.body.appendChild(p);
}
</script>

<div id="app">
  <header>
    <div class="logo" onclick="navigate('home')">Ù…Ø¬Ù„Ø³<span class="logo-sub">Unmarried Gathering</span></div>
    <div class="header-center">
      <div class="hijri-date" id="hijri-date"></div>
    </div>
    <div class="header-right" id="header-right">
      <button class="btn btn-outline btn-sm" onclick="showModal('login')">Ø¯Ø®ÙˆÙ„</button>
      <button class="btn btn-gold btn-sm" onclick="showModal('register')">ØªÙØ¶Ù„</button>
    </div>
  </header>

  <div id="page-home" class="page active">
    <div class="home-hero">
      <div class="hero-arch">
        <h1>Ù…Ø¬Ù„Ø³<span>Enter the Gathering</span></h1>
      </div>
      <div class="hero-actions" id="hero-actions">
        <button class="btn btn-gold" onclick="showModal('register')">âœ¦ Ø§Ù†Ø¶Ù… Ø¥Ù„ÙŠÙ†Ø§</button>
        <button class="btn btn-outline" onclick="showModal('login')">Ø§Ø¯Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¹Ø©</button>
      </div>
    </div>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="ğŸ”  Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¬Ù„Ø³..." oninput="filterRooms()">
    </div>
    <div class="section-title">
      <span>âœ¦ Ø§Ù„Ù…Ø¬Ø§Ù„Ø³ Ø§Ù„Ù…ÙØªÙˆØ­Ø©</span>
      <button class="btn btn-gold btn-sm" id="create-room-btn" style="display:none" onclick="showModal('create-room')">+ Ø§ÙØªØ­ Ù…Ø¬Ù„Ø³Ø§Ù‹</button>
    </div>
    <div class="rooms-grid" id="rooms-grid"><div class="empty-state"><div class="icon">ğŸ•Œ</div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div></div>
  </div>

  <div id="page-chat" class="page">
    <div class="chat-header">
      <div>
        <div class="chat-room-name" id="chat-room-name"></div>
        <div class="chat-room-meta" id="chat-room-meta"></div>
      </div>
      <div class="chat-header-actions">
        <button class="btn btn-outline btn-sm" onclick="leaveRoom()">â† Ù…ØºØ§Ø¯Ø±Ø©</button>
        <button class="btn btn-danger btn-sm" id="delete-room-btn" style="display:none" onclick="deleteRoom()">Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù„Ø³</button>
      </div>
    </div>
    <div class="messages-area" id="messages-area"></div>
    <div class="chat-input-area">
      <div class="image-preview-wrap" id="img-preview-wrap">
        <img id="img-preview-thumb" class="image-preview-thumb" src="" alt="">
        <button class="remove-preview" onclick="clearImagePreview()">âœ•</button>
      </div>
      <div class="chat-input-row">
        <button class="img-upload-btn" onclick="document.getElementById('img-file-input').click()">ğŸ–¼</button>
        <input type="file" id="img-file-input" accept="image/*" style="display:none" onchange="handleImageSelect(event)">
        <textarea id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." rows="1" onkeydown="handleMsgKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" onclick="sendMessage()">â¤</button>
      </div>
    </div>
  </div>

  <div class="lightbox hidden" id="lightbox" onclick="closeLightbox()">
    <img id="lightbox-img" src="" alt="">
  </div>

  <!-- Register -->
  <div class="modal-overlay hidden" id="modal-register">
    <div class="modal">
      <svg class="modal-geo" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="20,2 24,13 36,13 27,20 30,32 20,25 10,32 13,20 4,13 16,13" stroke="#c9a84c" stroke-width="1" fill="none"/></svg>
      <h2>Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹</h2><div class="ornament">âœ¦ â—† âœ¦</div>
      <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="reg-username" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ..."></div>
      <div class="form-group"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="reg-email" placeholder="Ø¨Ø±ÙŠØ¯Ùƒ@example.com"></div>
      <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="reg-password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø±ÙŠØ©..."></div>
      <div class="error-msg" id="reg-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('register')">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-gold" id="reg-btn" data-label="Ø§Ù†Ø¶Ù…" onclick="register()">Ø§Ù†Ø¶Ù…</button>
      </div>
      <div class="divider">Ø¹Ø¶Ùˆ Ù…Ø³Ø¬Ù„ØŸ</div>
      <button class="btn btn-outline" style="width:100%" onclick="hideModal('register');showModal('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <!-- Login -->
  <div class="modal-overlay hidden" id="modal-login">
    <div class="modal">
      <svg class="modal-geo" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="20,2 24,13 36,13 27,20 30,32 20,25 10,32 13,20 4,13 16,13" stroke="#c9a84c" stroke-width="1" fill="none"/></svg>
      <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ</h2><div class="ornament">âœ¦ â—† âœ¦</div>
      <div class="form-group"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="login-email" placeholder="Ø¨Ø±ÙŠØ¯Ùƒ@example.com"></div>
      <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø±ÙŠØ©..."></div>
      <div class="error-msg" id="login-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('login')">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-gold" id="login-btn" data-label="Ø¯Ø®ÙˆÙ„" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <div class="divider">Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ØŸ</div>
      <button class="btn btn-outline" style="width:100%" onclick="hideModal('login');showModal('register')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </div>
  </div>

  <!-- Create Room -->
  <div class="modal-overlay hidden" id="modal-create-room">
    <div class="modal">
      <svg class="modal-geo" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="20,2 24,13 36,13 27,20 30,32 20,25 10,32 13,20 4,13 16,13" stroke="#c9a84c" stroke-width="1" fill="none"/></svg>
      <h2>Ø§ÙØªØ­ Ù…Ø¬Ù„Ø³Ø§Ù‹</h2><div class="ornament">âœ¦ â—† âœ¦</div>
      <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø³</label><input type="text" id="room-name-input" placeholder="Ø³Ù…Ù‘ Ù…Ø¬Ù„Ø³Ùƒ..."></div>
      <div class="form-group"><label>Ø§Ù„ÙˆØµÙ</label><input type="text" id="room-desc-input" placeholder="ØµÙ Ù…Ø¬Ù„Ø³Ùƒ..."></div>
      <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="password" id="room-pass-input" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ù…Ø¬Ù„Ø³ Ø§Ù„Ù…ÙØªÙˆØ­..."></div>
      <div class="error-msg" id="room-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('create-room')">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-gold" id="create-room-btn2" data-label="Ø§ÙØªØ­" onclick="createRoom()">Ø§ÙØªØ­</button>
      </div>
    </div>
  </div>

  <!-- Join Room -->
  <div class="modal-overlay hidden" id="modal-join-room">
    <div class="modal">
      <svg class="modal-geo" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="20,2 24,13 36,13 27,20 30,32 20,25 10,32 13,20 4,13 16,13" stroke="#c9a84c" stroke-width="1" fill="none"/></svg>
      <h2>Ù…Ø¬Ù„Ø³ Ù…Ø­Ù…ÙŠ</h2><div class="ornament">âœ¦ â—† âœ¦</div>
      <p style="color:var(--text2);text-align:center;margin-bottom:20px;font-family:'Amiri',serif;font-size:1rem;">Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø³ Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±</p>
      <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="join-pass-input" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø±ÙŠØ©..."></div>
      <div class="error-msg" id="join-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('join-room')">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-gold" onclick="joinRoomWithPassword()">ØªÙØ¶Ù„</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, setDoc, getDocs, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyBEyS6QjmOpS-DOKDdO1h-3qEKca79_HoA",
  authDomain:"majlis-61b79.firebaseapp.com",
  projectId:"majlis-61b79",
  storageBucket:"majlis-61b79.firebasestorage.app",
  messagingSenderId:"633132324226",
  appId:"1:633132324226:web:160eb3dfe90e03d052eb9b"
};

const fbApp = initializeApp(firebaseConfig);
const auth = getAuth(fbApp);
const db = getFirestore(fbApp);

let currentUser=null, allRooms=[], currentRoomId=null, pendingRoomId=null, imageData=null, msgUnsub=null, roomsUnsub=null;

// â”€â”€ Hijri Date â”€â”€
function showHijriDate(){
  try{
    const h = new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'numeric',month:'long',year:'numeric'}).format(new Date());
    document.getElementById('hijri-date').textContent = h;
  }catch(e){}
}
showHijriDate();

// â”€â”€ Auth â”€â”€
onAuthStateChanged(auth, user => {
  currentUser = user || null;
  updateHeaderUI();
  listenRooms();
});

window.register = async () => {
  const username=v('reg-username').trim(), email=v('reg-email').trim(), pass=v('reg-password');
  if(!username||!email||!pass) return showError('reg-error','ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
  if(pass.length<6) return showError('reg-error','ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
  setLoading('reg-btn',true);
  try{
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{displayName:username});
    currentUser=cred.user; hideModal('register'); clearFields(['reg-username','reg-email','reg-password']);
  }catch(e){showError('reg-error',friendlyError(e.code));}
  setLoading('reg-btn',false);
};

window.login = async () => {
  const email=v('login-email').trim(), pass=v('login-password');
  if(!email||!pass) return showError('login-error','ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
  setLoading('login-btn',true);
  try{
    await signInWithEmailAndPassword(auth,email,pass);
    hideModal('login'); clearFields(['login-email','login-password']);
  }catch(e){showError('login-error',friendlyError(e.code));}
  setLoading('login-btn',false);
};

window.logout = async () => { leaveRoom(); await signOut(auth); };

function updateHeaderUI(){
  const el=document.getElementById('header-right');
  const ha=document.getElementById('hero-actions');
  const cb=document.getElementById('create-room-btn');
  if(currentUser){
    const initials=(currentUser.displayName||currentUser.email).substring(0,2).toUpperCase();
    el.innerHTML=`<div class="user-badge"><div class="avatar">${initials}</div><span>${escHtml(currentUser.displayName||currentUser.email)}</span></div><button class="btn btn-outline btn-sm" onclick="logout()">Ø®Ø±ÙˆØ¬</button>`;
    ha.innerHTML=`<button class="btn btn-gold" onclick="showModal('create-room')">âœ¦ Ø§ÙØªØ­ Ù…Ø¬Ù„Ø³Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</button>`;
    cb.style.display='inline-flex';
  } else {
    el.innerHTML=`<button class="btn btn-outline btn-sm" onclick="showModal('login')">Ø¯Ø®ÙˆÙ„</button><button class="btn btn-gold btn-sm" onclick="showModal('register')">ØªÙØ¶Ù„</button>`;
    ha.innerHTML=`<button class="btn btn-gold" onclick="showModal('register')">âœ¦ Ø§Ù†Ø¶Ù… Ø¥Ù„ÙŠÙ†Ø§</button><button class="btn btn-outline" onclick="showModal('login')">Ø§Ø¯Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¹Ø©</button>`;
    cb.style.display='none';
  }
}

// â”€â”€ Rooms â”€â”€
function listenRooms(){
  if(roomsUnsub) roomsUnsub();
  const q=query(collection(db,'rooms'),orderBy('createdAt','desc'));
  roomsUnsub=onSnapshot(q,snap=>{
    allRooms=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderRooms();
  });
}

function renderRooms(){
  const grid=document.getElementById('rooms-grid');
  const qry=(v('search-input')||'').toLowerCase();
  let arr=allRooms;
  if(qry) arr=arr.filter(r=>r.name.toLowerCase().includes(qry)||(r.desc||'').toLowerCase().includes(qry));
  if(!arr.length){
    grid.innerHTML=`<div class="empty-state"><div class="icon">ğŸ•Œ</div><p>${qry?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ø§Ù„Ø³ Ù…Ø·Ø§Ø¨Ù‚Ø©':'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ø§Ù„Ø³ Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙØªØ­ Ù…Ø¬Ù„Ø³Ø§Ù‹!'}</p></div>`;
    return;
  }
  grid.innerHTML=arr.map(r=>{
    const lock=r.password?'ğŸ”’':'ğŸ”“';
    const isOwner=currentUser&&currentUser.uid===r.ownerId;
    return `<div class="room-card" onclick="tryEnterRoom('${r.id}')">
      <div class="room-card-header"><div class="room-name">${escHtml(r.name)}</div><span>${lock}</span></div>
      <div class="room-desc">${escHtml(r.desc||'Ù…Ø¬Ù„Ø³ Ù„Ù„Ø­ÙˆØ§Ø± ÙˆØ§Ù„Ù†Ù‚Ø§Ø´...')}</div>
      <div class="room-meta">
        <span class="room-tag">Ø¨Ù‚Ù„Ù… ${escHtml(r.ownerName)}</span>
        <span class="room-tag">${r.msgCount||0} Ø£Ø­Ø§Ø¯ÙŠØ«</span>
        ${isOwner?'<span class="room-tag" style="border-color:rgba(201,168,76,0.5);color:var(--gold)">Ù…Ø¬Ù„Ø³Ùƒ</span>':''}
      </div>
    </div>`;
  }).join('');
}

window.filterRooms=renderRooms;

window.createRoom=async()=>{
  if(!currentUser) return;
  const name=v('room-name-input').trim(), desc=v('room-desc-input').trim(), pass=v('room-pass-input');
  if(!name) return showError('room-error','ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø³');
  setLoading('create-room-btn2',true);
  try{
    await addDoc(collection(db,'rooms'),{name,desc,password:pass,ownerId:currentUser.uid,ownerName:currentUser.displayName||currentUser.email,createdAt:serverTimestamp(),msgCount:0});
    hideModal('create-room'); clearFields(['room-name-input','room-desc-input','room-pass-input']);
  }catch(e){showError('room-error',e.message);}
  setLoading('create-room-btn2',false);
};

window.tryEnterRoom=id=>{
  if(!currentUser){showModal('login');return;}
  const room=allRooms.find(r=>r.id===id);
  if(!room) return;
  if(room.password){pendingRoomId=id;showModal('join-room');}
  else enterRoom(id);
};

window.joinRoomWithPassword=()=>{
  const room=allRooms.find(r=>r.id===pendingRoomId);
  if(!room) return;
  if(v('join-pass-input')!==room.password) return showError('join-error','ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
  hideModal('join-room'); clearFields(['join-pass-input']); enterRoom(pendingRoomId);
};

function enterRoom(id){
  currentRoomId=id;
  const room=allRooms.find(r=>r.id===id);
  document.getElementById('chat-room-name').textContent=room.name;
  document.getElementById('chat-room-meta').textContent=(room.desc||'')+(room.password?'  ğŸ”’ Ù…Ø­Ù…ÙŠ':'  ğŸ”“ Ù…ÙØªÙˆØ­');
  document.getElementById('delete-room-btn').style.display=(currentUser.uid===room.ownerId)?'inline-flex':'none';
  navigate('chat');
  listenMessages(id);
  addDoc(collection(db,'rooms',id,'messages'),{type:'system',text:`Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ù€ ${currentUser.displayName||currentUser.email} ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø³`,ts:serverTimestamp()});
}

window.leaveRoom=()=>{
  if(msgUnsub){msgUnsub();msgUnsub=null;}
  currentRoomId=null;
  document.getElementById('messages-area').innerHTML='';
  navigate('home');
};

window.deleteRoom=async()=>{
  const room=allRooms.find(r=>r.id===currentRoomId);
  if(!room||room.ownerId!==currentUser.uid) return;
  if(!confirm(`Ø­Ø°Ù Ù…Ø¬Ù„Ø³ "${room.name}"ØŸ`)) return;
  const msgs=await getDocs(collection(db,'rooms',currentRoomId,'messages'));
  for(const m of msgs.docs) await deleteDoc(m.ref);
  await deleteDoc(doc(db,'rooms',currentRoomId));
  leaveRoom();
};

// â”€â”€ Messages â”€â”€
function listenMessages(roomId){
  if(msgUnsub) msgUnsub();
  const q=query(collection(db,'rooms',roomId,'messages'),orderBy('ts','asc'));
  msgUnsub=onSnapshot(q,snap=>{
    const area=document.getElementById('messages-area');
    const atBottom=area.scrollHeight-area.clientHeight<=area.scrollTop+60;
    area.innerHTML=snap.docs.map(d=>{
      const m=d.data();
      if(m.type==='system') return `<div class="msg system"><div class="msg-bubble"><div class="msg-text">${escHtml(m.text)}</div></div></div>`;
      const isOwn=m.authorId===currentUser.uid;
      const initials=(m.author||'?').substring(0,2).toUpperCase();
      const time=m.ts?new Date(m.ts.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'';
      const imgHtml=m.image?`<img class="msg-img" src="${m.image}" onclick="openLightbox(this.src)">`:''
      return `<div class="msg ${isOwn?'own':''}">
        <div class="msg-avatar"><div class="avatar">${initials}</div></div>
        <div class="msg-bubble">
          ${isOwn?'':`<div class="msg-author">${escHtml(m.author)}</div>`}
          ${m.text?`<div class="msg-text">${escHtml(m.text)}</div>`:''}
          ${imgHtml}
          <div class="msg-time">${time}</div>
        </div>
      </div>`;
    }).join('');
    if(atBottom) area.scrollTop=area.scrollHeight;
    if(currentRoomId===roomId) setDoc(doc(db,'rooms',roomId),{msgCount:snap.size},{merge:true});
  });
}

window.sendMessage=async()=>{
  const text=document.getElementById('msg-input').value.trim();
  const img=imageData;
  if(!text&&!img) return;
  if(!currentUser||!currentRoomId) return;
  document.getElementById('msg-input').value='';
  document.getElementById('msg-input').style.height='auto';
  clearImagePreview();
  await addDoc(collection(db,'rooms',currentRoomId,'messages'),{type:'user',author:currentUser.displayName||currentUser.email,authorId:currentUser.uid,text:text||'',image:img||null,ts:serverTimestamp()});
};

window.handleImageSelect=e=>{
  const file=e.target.files[0];
  if(!file) return;
  if(file.size>3*1024*1024){alert('Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 3 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');return;}
  const reader=new FileReader();
  reader.onload=ev=>{imageData=ev.target.result;document.getElementById('img-preview-thumb').src=ev.target.result;document.getElementById('img-preview-wrap').classList.add('show');};
  reader.readAsDataURL(file); e.target.value='';
};

window.clearImagePreview=()=>{imageData=null;document.getElementById('img-preview-wrap').classList.remove('show');document.getElementById('img-preview-thumb').src='';};
window.openLightbox=src=>{document.getElementById('lightbox-img').src=src;document.getElementById('lightbox').classList.remove('hidden');};
window.closeLightbox=()=>document.getElementById('lightbox').classList.add('hidden');
window.navigate=page=>{document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+page).classList.add('active');};
window.showModal=id=>document.getElementById('modal-'+id).classList.remove('hidden');
window.hideModal=id=>{document.getElementById('modal-'+id).classList.add('hidden');clearErrors();};
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.add('hidden');}));
window.handleMsgKey=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}};
window.autoResize=el=>{el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';};
document.getElementById('login-password').addEventListener('keydown',e=>{if(e.key==='Enter')login();});
document.getElementById('join-pass-input').addEventListener('keydown',e=>{if(e.key==='Enter')joinRoomWithPassword();});

function v(id){const el=document.getElementById(id);return el?el.value:'';}
function clearFields(ids){ids.forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});}
function showError(id,msg){const el=document.getElementById(id);if(el){el.textContent=msg;el.classList.add('show');}}
function clearErrors(){document.querySelectorAll('.error-msg').forEach(e=>e.classList.remove('show'));}
function escHtml(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function setLoading(id,on){const el=document.getElementById(id);if(!el)return;el.disabled=on;el.textContent=on?'...':el.getAttribute('data-label');}
function friendlyError(code){const map={'auth/email-already-in-use':'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹','auth/invalid-email':'Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­','auth/weak-password':'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹','auth/user-not-found':'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯','auth/wrong-password':'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©','auth/invalid-credential':'Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©'};return map[code]||'Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';}
</script>
</body>
</html>
