<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ŸÖÿ¨ŸÑÿ≥</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap');

  :root {
    --gold: #c9a84c;
    --gold2: #f0d080;
    --gold3: #8b6914;
    --dark: #0d0a05;
    --dark2: #1a1408;
    --dark3: #241c0c;
    --dark4: #2e2410;
    --panel: rgba(20,14,4,0.95);
    --border: rgba(201,168,76,0.3);
    --border2: rgba(201,168,76,0.6);
    --text: #e8d5a3;
    --text2: #b8a070;
    --red: #c0392b;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Lora', serif;
    background: var(--dark);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background pattern */
  body::before {
    content:'';
    position:fixed; inset:0;
    background-image:
      radial-gradient(ellipse at 20% 50%, rgba(201,168,76,0.04) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 50%, rgba(201,168,76,0.04) 0%, transparent 60%),
      url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c9a84c' fill-opacity='0.03'%3E%3Cpath d='M30 0l5 10 11-3-6 9 6 9-11-3-5 10-5-10-11 3 6-9-6-9 11 3z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    pointer-events:none; z-index:0;
  }

  #app { position:relative; z-index:1; }

  /* ===== HEADER ===== */
  header {
    background: linear-gradient(180deg, rgba(10,7,2,0.98) 0%, rgba(15,11,4,0.95) 100%);
    border-bottom: 1px solid var(--border2);
    padding: 0 24px;
    display: flex; align-items: center; justify-content: space-between;
    height: 64px;
    position: sticky; top:0; z-index:100;
    box-shadow: 0 2px 20px rgba(201,168,76,0.15);
  }

  .logo {
    font-family: 'Cinzel', serif;
    font-size: 1.6rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--gold3), var(--gold), var(--gold2), var(--gold));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: 3px;
    text-shadow: none;
  }

  .logo-sub { font-size:0.65rem; letter-spacing:5px; display:block; font-family:'Lora',serif; font-style:italic; -webkit-text-fill-color: var(--text2); margin-top:-4px; }

  .header-right { display:flex; align-items:center; gap:12px; }

  .user-badge {
    display:flex; align-items:center; gap:8px;
    background: var(--dark3);
    border:1px solid var(--border);
    border-radius:24px;
    padding:6px 14px 6px 8px;
    font-size:0.85rem; color: var(--text2);
  }

  .avatar {
    width:30px; height:30px; border-radius:50%;
    background: linear-gradient(135deg, var(--gold3), var(--gold));
    display:flex; align-items:center; justify-content:center;
    font-size:0.8rem; font-weight:700; color: var(--dark);
    flex-shrink:0;
  }

  /* ===== BUTTONS ===== */
  .btn {
    font-family:'Lora',serif;
    border:none; cursor:pointer;
    border-radius:6px; font-size:0.9rem;
    transition: all 0.2s;
  }

  .btn-gold {
    background: linear-gradient(135deg, var(--gold3), var(--gold));
    color: var(--dark);
    padding: 10px 20px;
    font-weight:600;
    border: 1px solid var(--gold2);
  }
  .btn-gold:hover { background: linear-gradient(135deg, var(--gold), var(--gold2)); transform:translateY(-1px); box-shadow:0 4px 15px rgba(201,168,76,0.3); }

  .btn-outline {
    background: transparent;
    color: var(--gold);
    padding: 9px 18px;
    border: 1px solid var(--border2);
  }
  .btn-outline:hover { background: rgba(201,168,76,0.1); border-color: var(--gold); }

  .btn-danger {
    background: rgba(192,57,43,0.15);
    color: #e74c3c;
    padding: 7px 14px;
    border: 1px solid rgba(192,57,43,0.3);
    font-size:0.8rem;
  }
  .btn-danger:hover { background: rgba(192,57,43,0.3); }

  .btn-sm { padding:6px 14px; font-size:0.82rem; }

  /* ===== MODALS ===== */
  .modal-overlay {
    position:fixed; inset:0;
    background: rgba(0,0,0,0.85);
    display:flex; align-items:center; justify-content:center;
    z-index:200; padding:20px;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.hidden { display:none; }

  .modal {
    background: linear-gradient(160deg, var(--dark3) 0%, var(--dark2) 100%);
    border: 1px solid var(--border2);
    border-radius:12px;
    padding:32px;
    width:100%; max-width:440px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 40px rgba(201,168,76,0.1);
    position:relative;
  }

  .modal::before {
    content:'';
    position:absolute; top:0; left:0; right:0;
    height:2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    border-radius:12px 12px 0 0;
  }

  .modal h2 {
    font-family:'Cinzel',serif;
    color: var(--gold);
    text-align:center;
    margin-bottom:24px;
    font-size:1.4rem;
    letter-spacing:2px;
  }

  .ornament { text-align:center; color:var(--gold3); margin:-16px 0 16px; font-size:1.2rem; letter-spacing:8px; }

  .form-group { margin-bottom:16px; }
  .form-group label { display:block; color:var(--text2); font-size:0.82rem; margin-bottom:6px; letter-spacing:1px; text-transform:uppercase; }

  input[type=text], input[type=password], textarea {
    width:100%;
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    border-radius:6px;
    padding:10px 14px;
    color: var(--text);
    font-family:'Lora',serif;
    font-size:0.9rem;
    transition: border-color 0.2s;
    outline:none;
  }
  input:focus, textarea:focus { border-color: var(--gold); box-shadow:0 0 0 2px rgba(201,168,76,0.1); }

  .form-actions { display:flex; gap:10px; margin-top:20px; }
  .form-actions .btn { flex:1; }

  .error-msg { color:#e74c3c; font-size:0.8rem; margin-top:8px; display:none; }
  .error-msg.show { display:block; }

  .divider { text-align:center; color:var(--text2); font-size:0.8rem; margin:16px 0; position:relative; }
  .divider::before, .divider::after { content:''; position:absolute; top:50%; width:38%; height:1px; background:var(--border); }
  .divider::before { left:0; } .divider::after { right:0; }

  /* ===== HOME PAGE ===== */
  #page-home { padding:32px 24px; max-width:1100px; margin:0 auto; }

  .home-hero {
    text-align:center;
    padding: 40px 0 48px;
    position:relative;
  }

  .home-hero h1 {
    font-family:'Cinzel',serif;
    font-size:clamp(1.8rem,5vw,3rem);
    background: linear-gradient(135deg, var(--gold3), var(--gold), var(--gold2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    margin-bottom:8px;
    letter-spacing:4px;
  }

  .home-hero p { color:var(--text2); font-style:italic; font-size:1rem; margin-bottom:32px; }

  .hero-actions { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }

  .search-bar {
    display:flex; gap:10px; margin-bottom:32px;
  }
  .search-bar input {
    flex:1;
    background: rgba(0,0,0,0.5);
    border:1px solid var(--border);
    border-radius:8px;
    padding:12px 16px;
    color:var(--text);
    font-family:'Lora',serif;
    font-size:0.95rem;
    outline:none;
  }
  .search-bar input:focus { border-color:var(--gold); }
  .search-bar input::placeholder { color:var(--text2); }

  .section-title {
    font-family:'Cinzel',serif;
    color:var(--gold);
    font-size:1rem;
    letter-spacing:3px;
    text-transform:uppercase;
    margin-bottom:20px;
    padding-bottom:8px;
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between;
  }

  .rooms-grid {
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(280px,1fr));
    gap:18px;
  }

  .room-card {
    background: linear-gradient(160deg, var(--dark3) 0%, var(--dark2) 100%);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    cursor:pointer;
    transition: all 0.25s;
    position:relative;
    overflow:hidden;
  }

  .room-card::before {
    content:'';
    position:absolute; top:0; left:0; right:0;
    height:1px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    opacity:0; transition:opacity 0.25s;
  }

  .room-card:hover { border-color:var(--border2); transform:translateY(-3px); box-shadow:0 8px 30px rgba(201,168,76,0.15); }
  .room-card:hover::before { opacity:1; }

  .room-card-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:10px; }
  .room-name { font-family:'Cinzel',serif; color:var(--gold); font-size:1rem; letter-spacing:1px; }
  .room-lock { font-size:0.85rem; }

  .room-desc { color:var(--text2); font-size:0.85rem; font-style:italic; margin-bottom:12px; line-height:1.5; }

  .room-meta { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .room-tag {
    font-size:0.72rem; letter-spacing:1px; text-transform:uppercase;
    padding:3px 10px; border-radius:20px;
    background:rgba(201,168,76,0.08); border:1px solid var(--border);
    color:var(--text2);
  }
  .room-tag.online { background:rgba(46,204,113,0.08); border-color:rgba(46,204,113,0.3); color:#2ecc71; }

  .empty-state { text-align:center; padding:60px 20px; color:var(--text2); }
  .empty-state .icon { font-size:3rem; margin-bottom:16px; opacity:0.5; }
  .empty-state p { font-style:italic; }

  /* ===== CHAT PAGE ===== */
  #page-chat { display:flex; flex-direction:column; height:calc(100vh - 64px); }

  .chat-header {
    background: linear-gradient(180deg, rgba(10,7,2,0.98) 0%, rgba(20,14,4,0.95) 100%);
    border-bottom:1px solid var(--border);
    padding:14px 24px;
    display:flex; align-items:center; justify-content:space-between;
    flex-shrink:0;
  }

  .chat-room-name { font-family:'Cinzel',serif; color:var(--gold); font-size:1.1rem; letter-spacing:2px; }
  .chat-room-meta { color:var(--text2); font-size:0.8rem; margin-top:2px; }
  .chat-header-actions { display:flex; gap:8px; }

  .messages-area {
    flex:1; overflow-y:auto;
    padding:20px 24px;
    display:flex; flex-direction:column; gap:12px;
  }

  .messages-area::-webkit-scrollbar { width:5px; }
  .messages-area::-webkit-scrollbar-track { background:transparent; }
  .messages-area::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  .msg {
    display:flex; gap:10px; align-items:flex-end;
    max-width:70%;
  }
  .msg.own { align-self:flex-end; flex-direction:row-reverse; }
  .msg.system { align-self:center; max-width:100%; }

  .msg-avatar { width:32px; height:32px; flex-shrink:0; }
  .msg-avatar .avatar { width:32px; height:32px; font-size:0.75rem; }

  .msg-bubble {
    background: linear-gradient(160deg, var(--dark3), var(--dark4));
    border:1px solid var(--border);
    border-radius:12px 12px 12px 4px;
    padding:10px 14px;
    max-width:100%;
  }
  .msg.own .msg-bubble {
    background: linear-gradient(160deg, rgba(139,105,20,0.25), rgba(90,65,10,0.3));
    border-color: rgba(201,168,76,0.3);
    border-radius:12px 12px 4px 12px;
  }

  .msg-author { font-size:0.75rem; color:var(--gold); margin-bottom:4px; font-weight:600; }
  .msg-text { font-size:0.9rem; line-height:1.5; word-break:break-word; }
  .msg-time { font-size:0.68rem; color:var(--text2); margin-top:4px; text-align:right; }

  .msg-img { max-width:280px; max-height:280px; border-radius:8px; display:block; margin-top:6px; cursor:pointer; transition:opacity 0.2s; }
  .msg-img:hover { opacity:0.9; }

  .msg.system .msg-bubble {
    background:rgba(201,168,76,0.06);
    border-color:var(--border);
    border-radius:20px;
    padding:6px 16px;
    text-align:center;
  }
  .msg.system .msg-text { font-size:0.78rem; color:var(--text2); font-style:italic; }

  .chat-input-area {
    background: rgba(10,7,2,0.97);
    border-top:1px solid var(--border);
    padding:16px 20px;
    flex-shrink:0;
  }

  .chat-input-row {
    display:flex; gap:10px; align-items:flex-end;
    background: rgba(0,0,0,0.4);
    border:1px solid var(--border);
    border-radius:10px;
    padding:8px 12px;
    transition: border-color 0.2s;
  }
  .chat-input-row:focus-within { border-color:var(--gold); }

  #msg-input {
    flex:1; background:transparent; border:none;
    color:var(--text); font-family:'Lora',serif; font-size:0.9rem;
    resize:none; outline:none; max-height:120px; min-height:36px;
    line-height:1.5; padding-top:4px;
  }

  .img-upload-btn {
    background:none; border:none; cursor:pointer;
    color:var(--gold3); font-size:1.3rem; padding:4px 6px;
    transition:color 0.2s; line-height:1;
  }
  .img-upload-btn:hover { color:var(--gold); }

  .send-btn {
    background: linear-gradient(135deg, var(--gold3), var(--gold));
    border:none; border-radius:6px; cursor:pointer;
    width:36px; height:36px; display:flex; align-items:center; justify-content:center;
    color:var(--dark); font-size:1rem; transition:all 0.2s; flex-shrink:0;
  }
  .send-btn:hover { background: linear-gradient(135deg, var(--gold), var(--gold2)); transform:scale(1.05); }

  .image-preview-wrap {
    display:none; padding:8px 0;
    position:relative; width:fit-content;
  }
  .image-preview-wrap.show { display:block; }
  .image-preview-thumb { width:80px; height:80px; object-fit:cover; border-radius:6px; border:1px solid var(--border2); }
  .remove-preview {
    position:absolute; top:-6px; right:-6px;
    background:var(--red); color:#fff; border:none; border-radius:50%;
    width:18px; height:18px; cursor:pointer; font-size:0.65rem;
    display:flex; align-items:center; justify-content:center;
  }

  /* Image lightbox */
  .lightbox {
    position:fixed; inset:0;
    background:rgba(0,0,0,0.92);
    display:flex; align-items:center; justify-content:center;
    z-index:300; cursor:zoom-out;
    backdrop-filter:blur(8px);
  }
  .lightbox.hidden { display:none; }
  .lightbox img { max-width:90vw; max-height:90vh; border-radius:8px; border:1px solid var(--border2); }

  /* Tabs in header when logged in */
  .tab-pill {
    display:inline-flex;
    background:rgba(0,0,0,0.4);
    border:1px solid var(--border);
    border-radius:20px;
    overflow:hidden;
  }
  .tab-pill button {
    background:none; border:none; color:var(--text2);
    padding:5px 14px; font-size:0.8rem; cursor:pointer;
    font-family:'Lora',serif; transition:all 0.2s;
  }
  .tab-pill button.active { background:rgba(201,168,76,0.15); color:var(--gold); }

  .page { display:none; }
  .page.active { display:block; }
  #page-chat.active { display:flex; }

  /* Responsive */
  @media(max-width:600px) {
    header { padding:0 14px; }
    #page-home { padding:20px 14px; }
    .msg { max-width:88%; }
    .messages-area { padding:14px; }
    .chat-input-area { padding:12px; }
  }
</style>
</head>
<body>

<div id="app">
  <!-- HEADER -->
  <header>
    <div class="logo" onclick="navigate('home')" style="cursor:pointer;">
      ŸÖÿ¨ŸÑÿ≥
      <span class="logo-sub">Unmarried Gathering</span>
    </div>
    <div class="header-right" id="header-right">
      <button class="btn btn-outline btn-sm" onclick="showModal('login')">Sign In</button>
      <button class="btn btn-gold btn-sm" onclick="showModal('register')">Join</button>
    </div>
  </header>

  <!-- PAGES -->
  <div id="page-home" class="page active">
    <div class="home-hero">
      <h1>Enter the Majlis</h1>
      <p>Where conversations flow like desert winds...</p>
      <div class="hero-actions" id="hero-actions">
        <button class="btn btn-gold" onclick="showModal('register')">‚ú¶ Create Account</button>
        <button class="btn btn-outline" onclick="showModal('login')">Enter the Hall</button>
      </div>
    </div>

    <div class="search-bar">
      <input type="text" id="search-input" placeholder="üîç  Search gathering rooms..." oninput="renderRooms()">
    </div>

    <div class="section-title">
      <span>‚ú¶ Open Gatherings</span>
      <button class="btn btn-gold btn-sm" id="create-room-btn" style="display:none" onclick="showModal('create-room')">+ New Room</button>
    </div>
    <div class="rooms-grid" id="rooms-grid"></div>
  </div>

  <div id="page-chat" class="page">
    <div class="chat-header">
      <div>
        <div class="chat-room-name" id="chat-room-name">Room</div>
        <div class="chat-room-meta" id="chat-room-meta"></div>
      </div>
      <div class="chat-header-actions">
        <button class="btn btn-outline btn-sm" onclick="navigate('home')">‚Üê Leave</button>
        <button class="btn btn-danger btn-sm" id="delete-room-btn" style="display:none" onclick="deleteRoom()">Delete Room</button>
      </div>
    </div>
    <div class="messages-area" id="messages-area"></div>
    <div class="chat-input-area">
      <div class="image-preview-wrap" id="img-preview-wrap">
        <img id="img-preview-thumb" class="image-preview-thumb" src="" alt="">
        <button class="remove-preview" onclick="clearImagePreview()">‚úï</button>
      </div>
      <div class="chat-input-row">
        <button class="img-upload-btn" onclick="document.getElementById('img-file-input').click()" title="Upload image">üñº</button>
        <input type="file" id="img-file-input" accept="image/*" style="display:none" onchange="handleImageSelect(event)">
        <textarea id="msg-input" placeholder="Write your message..." rows="1" onkeydown="handleMsgKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <!-- LIGHTBOX -->
  <div class="lightbox hidden" id="lightbox" onclick="closeLightbox()">
    <img id="lightbox-img" src="" alt="">
  </div>

  <!-- MODALS -->
  <!-- Register -->
  <div class="modal-overlay hidden" id="modal-register">
    <div class="modal">
      <h2>Join the Majlis</h2>
      <div class="ornament">‚ú¶ ‚óÜ ‚ú¶</div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="reg-username" placeholder="Choose your name...">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="reg-password" placeholder="Secret word...">
      </div>
      <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" id="reg-confirm" placeholder="Repeat secret word...">
      </div>
      <div class="error-msg" id="reg-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('register')">Cancel</button>
        <button class="btn btn-gold" onclick="register()">Create Account</button>
      </div>
      <div class="divider">already a member?</div>
      <button class="btn btn-outline" style="width:100%" onclick="hideModal('register');showModal('login')">Sign In Instead</button>
    </div>
  </div>

  <!-- Login -->
  <div class="modal-overlay hidden" id="modal-login">
    <div class="modal">
      <h2>Enter the Hall</h2>
      <div class="ornament">‚ú¶ ‚óÜ ‚ú¶</div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="login-username" placeholder="Your name...">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="login-password" placeholder="Secret word...">
      </div>
      <div class="error-msg" id="login-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('login')">Cancel</button>
        <button class="btn btn-gold" onclick="login()">Enter</button>
      </div>
      <div class="divider">new here?</div>
      <button class="btn btn-outline" style="width:100%" onclick="hideModal('login');showModal('register')">Create Account</button>
    </div>
  </div>

  <!-- Create Room -->
  <div class="modal-overlay hidden" id="modal-create-room">
    <div class="modal">
      <h2>Open a Gathering</h2>
      <div class="ornament">‚ú¶ ‚óÜ ‚ú¶</div>
      <div class="form-group">
        <label>Room Name</label>
        <input type="text" id="room-name-input" placeholder="Name your gathering...">
      </div>
      <div class="form-group">
        <label>Description</label>
        <input type="text" id="room-desc-input" placeholder="Describe the gathering...">
      </div>
      <div class="form-group">
        <label>Password (optional ‚Äî leave blank for open room)</label>
        <input type="password" id="room-pass-input" placeholder="Set a password...">
      </div>
      <div class="error-msg" id="room-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('create-room')">Cancel</button>
        <button class="btn btn-gold" onclick="createRoom()">Open Room</button>
      </div>
    </div>
  </div>

  <!-- Join Room (password) -->
  <div class="modal-overlay hidden" id="modal-join-room">
    <div class="modal">
      <h2>Enter the Gathering</h2>
      <div class="ornament">‚ú¶ ‚óÜ ‚ú¶</div>
      <p style="color:var(--text2);text-align:center;margin-bottom:20px;font-style:italic">This gathering is protected. Enter the password to join.</p>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="join-pass-input" placeholder="Secret word...">
      </div>
      <div class="error-msg" id="join-error"></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="hideModal('join-room')">Cancel</button>
        <button class="btn btn-gold" onclick="joinRoomWithPassword()">Enter</button>
      </div>
    </div>
  </div>
</div>

<script>
// ===================== STATE =====================
let state = {
  currentUser: null,
  currentRoomId: null,
  pendingRoomId: null,
  imageData: null,
  pollInterval: null
};

// ===================== STORAGE =====================
const S = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch(e) { return null; } },
  set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
  getUsers: () => S.get('mj_users') || {},
  setUsers: u => S.set('mj_users', u),
  getRooms: () => S.get('mj_rooms') || {},
  setRooms: r => S.set('mj_rooms', r),
  getMessages: id => S.get('mj_msgs_' + id) || [],
  setMessages: (id, m) => S.set('mj_msgs_' + id, m),
  getSession: () => S.get('mj_session'),
  setSession: u => S.set('mj_session', u),
  clearSession: () => localStorage.removeItem('mj_session')
};

// ===================== INIT =====================
function init() {
  const session = S.getSession();
  if (session) {
    const users = S.getUsers();
    if (users[session]) { state.currentUser = session; updateHeaderUI(); }
  }
  renderRooms();
}

// ===================== AUTH =====================
function register() {
  const u = val('reg-username').trim(), p = val('reg-password'), c = val('reg-confirm');
  if (!u || !p) return showError('reg-error', 'Please fill all fields.');
  if (p.length < 4) return showError('reg-error', 'Password must be at least 4 characters.');
  if (p !== c) return showError('reg-error', 'Passwords do not match.');
  const users = S.getUsers();
  if (users[u]) return showError('reg-error', 'Username already taken.');
  users[u] = { password: p, createdAt: Date.now() };
  S.setUsers(users);
  state.currentUser = u;
  S.setSession(u);
  hideModal('register');
  updateHeaderUI();
  renderRooms();
  clearFields(['reg-username','reg-password','reg-confirm']);
}

function login() {
  const u = val('login-username').trim(), p = val('login-password');
  if (!u || !p) return showError('login-error', 'Please fill all fields.');
  const users = S.getUsers();
  if (!users[u] || users[u].password !== p) return showError('login-error', 'Invalid username or password.');
  state.currentUser = u;
  S.setSession(u);
  hideModal('login');
  updateHeaderUI();
  renderRooms();
  clearFields(['login-username','login-password']);
}

function logout() {
  state.currentUser = null;
  S.clearSession();
  if (state.pollInterval) clearInterval(state.pollInterval);
  navigate('home');
  updateHeaderUI();
  renderRooms();
}

function updateHeaderUI() {
  const el = document.getElementById('header-right');
  const heroActions = document.getElementById('hero-actions');
  const createBtn = document.getElementById('create-room-btn');
  if (state.currentUser) {
    const initials = state.currentUser.substring(0,2).toUpperCase();
    el.innerHTML = `
      <div class="user-badge">
        <div class="avatar">${initials}</div>
        <span>${state.currentUser}</span>
      </div>
      <button class="btn btn-outline btn-sm" onclick="logout()">Leave</button>
    `;
    heroActions.innerHTML = `<button class="btn btn-gold" onclick="showModal('create-room')">‚ú¶ Open New Room</button>`;
    createBtn.style.display = 'inline-flex';
  } else {
    el.innerHTML = `
      <button class="btn btn-outline btn-sm" onclick="showModal('login')">Sign In</button>
      <button class="btn btn-gold btn-sm" onclick="showModal('register')">Join</button>
    `;
    heroActions.innerHTML = `
      <button class="btn btn-gold" onclick="showModal('register')">‚ú¶ Create Account</button>
      <button class="btn btn-outline" onclick="showModal('login')">Enter the Hall</button>
    `;
    createBtn.style.display = 'none';
  }
}

// ===================== ROOMS =====================
function createRoom() {
  if (!state.currentUser) return showError('room-error', 'You must be signed in.');
  const name = val('room-name-input').trim();
  const desc = val('room-desc-input').trim();
  const pass = val('room-pass-input');
  if (!name) return showError('room-error', 'Please enter a room name.');
  const rooms = S.getRooms();
  const id = 'room_' + Date.now();
  rooms[id] = { id, name, desc, password: pass, owner: state.currentUser, createdAt: Date.now(), memberCount: 0 };
  S.setRooms(rooms);
  hideModal('create-room');
  clearFields(['room-name-input','room-desc-input','room-pass-input']);
  renderRooms();
  enterRoom(id);
}

function renderRooms() {
  const grid = document.getElementById('rooms-grid');
  const query = (val('search-input')||'').toLowerCase();
  const rooms = S.getRooms();
  let arr = Object.values(rooms).sort((a,b) => b.createdAt - a.createdAt);
  if (query) arr = arr.filter(r => r.name.toLowerCase().includes(query) || (r.desc||'').toLowerCase().includes(query));
  if (!arr.length) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="icon">üïå</div><p>${query ? 'No rooms found for "'+query+'"' : 'No gatherings yet. Be the first to open one!'}</p></div>`;
    return;
  }
  grid.innerHTML = arr.map(r => {
    const msgs = S.getMessages(r.id);
    const lock = r.password ? 'üîí' : 'üîì';
    const msgCount = msgs.length;
    const isOwner = state.currentUser && state.currentUser === r.owner;
    return `<div class="room-card" onclick="tryEnterRoom('${r.id}')">
      <div class="room-card-header">
        <div class="room-name">${escHtml(r.name)}</div>
        <span class="room-lock" title="${r.password?'Protected':'Open'}">${lock}</span>
      </div>
      <div class="room-desc">${escHtml(r.desc || 'A gathering place for conversation...')}</div>
      <div class="room-meta">
        <span class="room-tag">by ${escHtml(r.owner)}</span>
        <span class="room-tag">${msgCount} messages</span>
        ${isOwner ? '<span class="room-tag" style="border-color:rgba(201,168,76,0.5);color:var(--gold)">Your Room</span>' : ''}
      </div>
    </div>`;
  }).join('');
}

function tryEnterRoom(id) {
  if (!state.currentUser) {
    showModal('login');
    return;
  }
  const rooms = S.getRooms();
  const room = rooms[id];
  if (!room) return;
  if (room.password) {
    state.pendingRoomId = id;
    showModal('join-room');
  } else {
    enterRoom(id);
  }
}

function joinRoomWithPassword() {
  const rooms = S.getRooms();
  const room = rooms[state.pendingRoomId];
  if (!room) return;
  const pass = val('join-pass-input');
  if (pass !== room.password) return showError('join-error', 'Incorrect password.');
  hideModal('join-room');
  clearFields(['join-pass-input']);
  enterRoom(state.pendingRoomId);
}

function enterRoom(id) {
  state.currentRoomId = id;
  const rooms = S.getRooms();
  const room = rooms[id];
  if (!room) return;

  document.getElementById('chat-room-name').textContent = room.name;
  document.getElementById('chat-room-meta').textContent = (room.desc || '') + (room.password ? '  üîí Protected' : '  üîì Open');

  const deleteBtn = document.getElementById('delete-room-btn');
  deleteBtn.style.display = (state.currentUser === room.owner) ? 'inline-flex' : 'none';

  // System message
  addSystemMessage(id, `${state.currentUser} has entered the gathering`);

  navigate('chat');
  renderMessages();

  if (state.pollInterval) clearInterval(state.pollInterval);
  state.pollInterval = setInterval(renderMessages, 2000);
}

function deleteRoom() {
  const rooms = S.getRooms();
  const room = rooms[state.currentRoomId];
  if (!room || room.owner !== state.currentUser) return;
  if (!confirm(`Delete the room "${room.name}"? This cannot be undone.`)) return;
  delete rooms[state.currentRoomId];
  S.setRooms(rooms);
  localStorage.removeItem('mj_msgs_' + state.currentRoomId);
  clearInterval(state.pollInterval);
  state.currentRoomId = null;
  navigate('home');
  renderRooms();
}

// ===================== MESSAGES =====================
function addSystemMessage(roomId, text) {
  const msgs = S.getMessages(roomId);
  msgs.push({ id: Date.now()+'_sys', type:'system', text, ts: Date.now() });
  S.setMessages(roomId, msgs);
}

function sendMessage() {
  const text = document.getElementById('msg-input').value.trim();
  const img = state.imageData;
  if (!text && !img) return;
  if (!state.currentUser || !state.currentRoomId) return;

  const msgs = S.getMessages(state.currentRoomId);
  msgs.push({
    id: Date.now() + '_' + Math.random().toString(36).substr(2,5),
    type: 'user',
    author: state.currentUser,
    text: text,
    image: img || null,
    ts: Date.now()
  });
  S.setMessages(state.currentRoomId, msgs);

  document.getElementById('msg-input').value = '';
  document.getElementById('msg-input').style.height = 'auto';
  clearImagePreview();
  renderMessages();
}

function renderMessages() {
  if (!state.currentRoomId) return;
  const msgs = S.getMessages(state.currentRoomId);
  const area = document.getElementById('messages-area');
  const wasAtBottom = area.scrollHeight - area.clientHeight <= area.scrollTop + 50;

  area.innerHTML = msgs.map(m => {
    if (m.type === 'system') {
      return `<div class="msg system"><div class="msg-bubble"><div class="msg-text">${escHtml(m.text)}</div></div></div>`;
    }
    const isOwn = m.author === state.currentUser;
    const initials = m.author.substring(0,2).toUpperCase();
    const time = new Date(m.ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const imgHtml = m.image ? `<img class="msg-img" src="${m.image}" alt="image" onclick="openLightbox('${m.image.replace(/'/g,"\\'")}')">` : '';
    return `<div class="msg ${isOwn?'own':''}">
      <div class="msg-avatar"><div class="avatar">${initials}</div></div>
      <div class="msg-bubble">
        ${isOwn ? '' : `<div class="msg-author">${escHtml(m.author)}</div>`}
        ${m.text ? `<div class="msg-text">${escHtml(m.text)}</div>` : ''}
        ${imgHtml}
        <div class="msg-time">${time}</div>
      </div>
    </div>`;
  }).join('');

  if (wasAtBottom) area.scrollTop = area.scrollHeight;
}

// ===================== IMAGE =====================
function handleImageSelect(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 3 * 1024 * 1024) { alert('Image must be under 3MB.'); return; }
  const reader = new FileReader();
  reader.onload = ev => {
    state.imageData = ev.target.result;
    document.getElementById('img-preview-thumb').src = ev.target.result;
    document.getElementById('img-preview-wrap').classList.add('show');
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

function clearImagePreview() {
  state.imageData = null;
  document.getElementById('img-preview-wrap').classList.remove('show');
  document.getElementById('img-preview-thumb').src = '';
}

function openLightbox(src) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox').classList.remove('hidden');
}
function closeLightbox() { document.getElementById('lightbox').classList.add('hidden'); }

// ===================== NAVIGATION =====================
function navigate(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  if (page === 'home') {
    if (state.pollInterval) { clearInterval(state.pollInterval); state.pollInterval = null; }
    renderRooms();
  }
}

// ===================== MODAL =====================
function showModal(id) {
  document.getElementById('modal-' + id).classList.remove('hidden');
}
function hideModal(id) {
  document.getElementById('modal-' + id).classList.add('hidden');
  clearErrors();
}

// Click outside to close
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.add('hidden');
  });
});

// ===================== UTILS =====================
function val(id) { const el = document.getElementById(id); return el ? el.value : ''; }
function clearFields(ids) { ids.forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; }); }
function showError(id, msg) { const el = document.getElementById(id); if(el){el.textContent=msg;el.classList.add('show');} }
function clearErrors() { document.querySelectorAll('.error-msg').forEach(e => e.classList.remove('show')); }
function escHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function handleMsgKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

// Enter key in login/register
document.getElementById('login-password').addEventListener('keydown', e => { if(e.key==='Enter') login(); });
document.getElementById('reg-confirm').addEventListener('keydown', e => { if(e.key==='Enter') register(); });
document.getElementById('join-pass-input').addEventListener('keydown', e => { if(e.key==='Enter') joinRoomWithPassword(); });

// ===================== START =====================
init();
</script>
</body>
</html>
